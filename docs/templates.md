# Listing Generator · Шаблоны, контексты и каскадные включения

Этот раздел описывает, как в LG устроена **шаблонизация**: комбинирование `*.ctx.md` (контекстов), `*.tpl.md` (шаблонов) и **секций** из `lg-cfg/` — в том числе c **адресными включениями** из других `lg-cfg`-скоупов в монорепозитории.

---

## Что тут чем является

* **Секции** — именованные наборы файлов + правила обработки (описаны в `sections.yaml` и `*.sec.yaml`). На рендере превращаются в «вставки текста».
* **Шаблоны** (`*.tpl.md`) — Markdown-фрагменты, в которых можно вставлять **секции** и **другие шаблоны/контексты**.
* **Контексты** (`*.ctx.md`) — «верхнеуровневые» документы. Их обычно отдаёте в LLM «как есть» (после развёртки плейсхолдеров).

> LG сначала **разрешает ссылки** (находит все секции и вложенные tpl/ctx), затем **строит манифест файлов**, обрабатывает их адаптерами и **сшивает** в финальный Markdown.

---

## Что хранить в `lg-cfg/` и как раскладывать

Внутренняя структура **свободная** — папки выбираете сами.

Минимальный набор:

```
lg-cfg/
├─ sections.yaml           # обязательный корневой файл (schema_version + базовые секции)
├─ **/*.sec.yaml           # произвольное число фрагментов секций (можно в подпапках)
├─ **/*.tpl.md             # шаблоны (фрагменты)
├─ **/*.ctx.md             # контексты (верхнеуровневые документы)
└─ models.yaml             # (необязательно) модели/планы для токен-статистики
```

> **Канонические ID секций**:
> • если во фрагменте `*.sec.yaml` **ровно одна** секция — её канон-ID = имя секции;
> • иначе — `prefix/section` (где `prefix` = путь фрагмента без суффикса `.sec.yaml`).
> Это позволяет избегать конфликтов и держать короткие ID.

---

## Плейсхолдеры и адресация (полная шпаргалка)

Плейсхолдеры допускают как `${…}`, так и `$…` (рекомендуем **фигурные**). Внутри имени разрешены: буквы/цифры/`_ - / : [ ] . @`.

### Вставка секций

* Текущий скоуп (этот `lg-cfg/`):
  `${my-section}`
* Из другого скоупа (адрес относительно **корня репо**, к каталогу, где лежит *его* `lg-cfg/`):
  `${@apps/web:my-section}`
* Скобочная форма, если в origin есть двоеточия:
  `${@[apps/web:legacy]:my-section}`

### Вставка шаблонов

* Локальный:
  `${tpl:common/intro}`
* Из другого скоупа:
  `${tpl@libs/math:docs/guide}`
  `${tpl@[libs/math:v2]:docs/guide}`

### Вставка контекста (вложенный ctx)

* Локальный:
  `${ctx:api/review}`
* Из другого скоупа:
  `${ctx@services/auth:hotfix}`

> **Двойной спецификатор пути** — это `origin:resource`:
> `origin` — путь к модулю **внутри репо**, где находится его `lg-cfg/`.
> `resource` — путь **внутри того `lg-cfg/`** (например, `tpl`/`ctx` имя или относительный путь).

---

## Универсальные правила через шаблоны

Шаблоны — лучшее место для **повторно используемых «каркасов»** промтов:

```markdown
<!-- lg-cfg/tpl/review.tpl.md -->
# Ревью изменения

${tpl:intro}  <!-- общая вводная -->

## Затронутые участки
${@apps/web:web-src}        <!-- секция с исходниками web -->
${@libs/math:math-core}     <!-- секция из другого пакета -->

## Чек-лист
- Архитектурные последствия?
- Тесты и документация?
```

Далее контекст «под конкретную задачу» просто собирает нужные блоки:

```markdown
<!-- lg-cfg/ctx/bugfix.ctx.md -->
# Быстрый bugfix-ревью

${tpl:review}
${tests}          <!-- локальная секция tests -->
```

Советы:

* Держите «общую часть» (переводные фразы, заголовки, чек-листы) в `tpl/`.
* На уровне секций управляйте «плотностью» через адаптеры и `targets` (например, резать тела функций в `pkg/**.py`).
* Для «комбинированных» документов используйте `max_heading_level` в Markdown-адаптере, чтобы итог выглядел ровно.

---

## Каскадные include’ы между скоупами (`lg-cfg` разных модулей)

В монорепозитории почти всегда есть **несколько** `lg-cfg/` — по модулям. LG разрешает **адресные** include’ы, а остальные `lg-cfg/` **лениво** обнаруживаются **только если вы на них сослались**.

Примеры адресности:

```markdown
${@apps/web:web-src}               <!-- секция из apps/web/lg-cfg/sections.yaml -->
${tpl@libs/math:dev/intro}         <!-- шаблон из libs/math/lg-cfg/dev/intro.tpl.md -->
${ctx@services/auth:hardening}     <!-- контекст из services/auth/lg-cfg/hardening.ctx.md -->
```
