# Listing Generator · Шаблоны, контексты и каскадные включения

Этот раздел описывает, как в LG устроена **шаблонизация**: комбинирование `*.ctx.md` (контекстов), `*.tpl.md` (шаблонов) и **секций** из `lg-cfg/` — в том числе c **адресными включениями** из других `lg-cfg`-скоупов в монорепозитории.

## Базовые концепции

Прежде чем углубляться в детали, разберёмся с ключевыми терминами.

### Репозиторий и скоуп

**Корень репозитория** — это верхнеуровневая директория вашего проекта, из которой запускается LG.

**Скоуп** (scope) — это любая директория, содержащая свою папку `lg-cfg/`. Скоуп определяет границу для конфигурации и ресурсов.

В простых проектах корень репозитория и скоуп — это одно и то же:

```
my-project/           ← корень репозитория = скоуп
├─ lg-cfg/
│  └─ ...
└─ src/
```

В монорепозиториях может быть **несколько скоупов** — один в корне и несколько в подмодулях:

```
monorepo/             ← корень репозитория = корневой скоуп
├─ lg-cfg/            ← конфиг корневого скоупа
├─ apps/
│  └─ web/            ← вложенный скоуп
│     ├─ lg-cfg/      ← конфиг веб-приложения
│     └─ src/
└─ libs/
   └─ core/           ← вложенный скоуп
      ├─ lg-cfg/      ← конфиг core-библиотеки
      └─ src/
```

### Разрешение путей: два вида относительности

Пути в LG могут быть относительными двумя разными способами:

1. **Относительно текущей директории** (внутри `lg-cfg/`):
   - Используется для путей `tpl:`, `ctx:` и `md@self:`
   - Меняется при навигации через вложенные включения
   - Пример: из `lg-cfg/docs/intro.ctx.md` путь `../common/header` разрешается в `lg-cfg/common/header`

2. **Относительно текущего скоупа** (директории, содержащей `lg-cfg/`):
   - Используется для ссылок `@origin` и `md:` без `@`
   - Пример: из скоупа `apps/web` путь `${md:README}` разрешается в `apps/web/README.md`

### Обращение к другим скоупам

Для ссылки на ресурсы из другого скоупа используется синтаксис `@origin`:

- `${@apps/web:section}` — секция из скоупа `apps/web` (относительно текущего скоупа)
- `${@/:section}` — секция из **корневого скоупа** (абсолютно)
- `${tpl@libs/core:intro}` — шаблон из скоупа `libs/core`

Путь после `@` всегда относителен **текущему скоупу**, а не корню репозитория. Используйте `@/` для явного обращения к корневому скоупу.

---

## Что тут чем является

* **Секции** — именованные наборы файлов + правила обработки (описаны в `sections.yaml` и `*.sec.yaml`). На рендере превращаются в «вставки текста».
* **Шаблоны** (`*.tpl.md`) — Markdown-фрагменты, в которых можно вставлять **секции** и **другие шаблоны/контексты**.
* **Контексты** (`*.ctx.md`) — «верхнеуровневые» документы. Их обычно отдаёте в LLM «как есть» (после развёртки плейсхолдеров).
* **Обычные MD** (`*.md`) — любые производные Markdown-документы, не связанные с экосистемой LG инструмента.

---

## Что хранить в `lg-cfg/` и как раскладывать

Внутренняя структура **свободная** — папки выбираете сами.

Минимальный набор:

```
lg-cfg/
├─ sections.yaml           # обязательный корневой файл (базовые секции)
├─ **/*.sec.yaml           # произвольное число фрагментов секций (можно в подпапках)
├─ **/*.tpl.md             # шаблоны (фрагменты)
├─ **/*.ctx.md             # контексты (верхнеуровневые документы)
└─ models.yaml             # (необязательно) модели/планы для токен-статистики
```

> **Канонические ID секций**:
> • если во фрагменте `*.sec.yaml` **ровно одна** секция — её канон-ID = имя секции;
> • иначе — `prefix/section` (где `prefix` = путь фрагмента без суффикса `.sec.yaml`).
> Это позволяет избегать конфликтов и держать короткие ID.

---

<!-- lg:if TAGSET:template-features:common-placeholders -->
## Плейсхолдеры и адресация (полная шпаргалка)

Плейсхолдеры допускают как `${…}`, так и `$…` (рекомендуем **фигурные**). Внутри имени разрешены: буквы/цифры/`_ - / : [ ] . @`.

### Вставка секций

* Текущий скоуп (этот `lg-cfg/`):
  `${my-section}`
* Из другого скоупа (адрес относительно **текущего скоупа**):
  `${@apps/web:my-section}`
* Корневой скоуп (явно):
  `${@/:my-section}`
* Скобочная форма, если в origin есть двоеточия:
  `${@[apps/web:legacy]:my-section}`

### Вставка шаблонов

* Локальный:
  `${tpl:common/intro}`
* Из другого скоупа:
  `${tpl@libs/math:docs/guide}`
  `${tpl@[libs/math:v2]:docs/guide}`

### Вставка контекста (вложенный ctx)

* Локальный:
  `${ctx:api/review}`
* Из другого скоупа:
  `${ctx@services/auth:hotfix}`

> **Двойной спецификатор пути** — это `origin:resource`:
> `origin` — путь к модулю **относительно текущего скоупа** (используйте `@/` для корневого скоупа).
> `resource` — путь **внутри того `lg-cfg/`** (например, `tpl`/`ctx` имя или относительный путь).

---

## Универсальные правила через шаблоны

Шаблоны — лучшее место для **повторно используемых «каркасов»** промтов:

```markdown
<!-- lg-cfg/tpl/review.tpl.md -->
# Ревью изменения

${tpl:intro}  <!-- общая вводная -->

## Затронутые участки
${@apps/web:web-src}        <!-- секция с исходниками web -->
${@libs/math:math-core}     <!-- секция из другого пакета -->

## Чек-лист
- Архитектурные последствия?
- Тесты и документация?
```

Далее контекст «под конкретную задачу» просто собирает нужные блоки:

```markdown
<!-- lg-cfg/ctx/bugfix.ctx.md -->
# Быстрый bugfix-ревью

${tpl:review}
${tests}          <!-- локальная секция tests -->
```

Советы:

* Держите «общую часть» (переводные фразы, заголовки, чек-листы) в `tpl/`.
* На уровне секций управляйте «плотностью» через адаптеры и `targets` (например, резать тела функций в `pkg/**.py`).
* Для «комбинированных» документов используйте `max_heading_level` в Markdown-адаптере, чтобы итог выглядел ровно.

---

## Каскадные include’ы между скоупами (`lg-cfg` разных модулей)

В монорепозитории почти всегда есть **несколько** `lg-cfg/` — по модулям. LG разрешает **адресные** include’ы, а остальные `lg-cfg/` **лениво** обнаруживаются **только если вы на них сослались**.

Примеры адресности:

```markdown
${@apps/web:web-src}               <!-- секция из apps/web/lg-cfg/sections.yaml -->
${tpl@libs/math:dev/intro}         <!-- шаблон из libs/math/lg-cfg/dev/intro.tpl.md -->
${ctx@services/auth:hardening}     <!-- контекст из services/auth/lg-cfg/hardening.ctx.md -->
```

<!-- lg:endif --> <!-- lg:if TAGSET:template-features:task-placeholder -->
## Плейсхолдер текущей задачи `${task}`

Специальный плейсхолдер для вставки динамического описания текущей задачи из CLI-аргумента `--task`.

### Базовое использование

#### Простая форма

```markdown
## Текущая задача

${task}
```

**Поведение:**
- Если передан `--task "текст"` → подставляется текст как есть
- Если `--task` не передан → подставляется пустая строка

**Пример команды:**
```bash
lg render ctx:dev --task "Реализовать кеширование результатов"
```

**Результат:**
```markdown
## Текущая задача

Реализовать кеширование результатов
```

#### Форма с дефолтным значением

```markdown
${task:prompt:"Ничего пока делать не нужно. Просто подтверди, что ты дочитал досюда."}
```

**Поведение:**
- Если передан `--task` → подставляется значение из аргумента
- Если `--task` не передан → подставляется дефолтное значение из `prompt:`

**Синтаксис дефолтного значения:**
- Формат: `${task:prompt:"текст"}`
- Ключевое слово `prompt:` обязательно
- Значение в двойных кавычках `"`
- Поддержка escape-последовательностей: `\"`, `\\`, `\n`, `\t`

**Примеры:**
```markdown
${task:prompt:"Simple text"}
${task:prompt:"Text with \"quotes\""}
${task:prompt:"Multiline\ntext\nhere"}
```

### Условная вставка

Можно использовать условие `{% if task %}` для включения блоков только при наличии задачи:

```markdown
# Контекст разработки

${tpl:intro}
${src-core}

{% if task %}
## Описание текущей задачи

${task}
{% endif %}
```

### Комбинирование с другими условиями

```markdown
{% if task AND tag:review %}
## Задача для ревью

${task}
{% endif %}

{% if NOT task %}
_Конкретная задача не указана. Общий обзор кодовой базы._
{% endif %}
```

### Варианты передачи задачи

**Прямая строка:**
```bash
lg render ctx:dev --task "Реализовать кеширование"
```

**Многострочный текст через stdin:**
```bash
echo -e "Задачи:\n- Исправить баг #123\n- Добавить тесты" | lg render ctx:dev --task -
```

**Из файла:**
```bash
lg render ctx:dev --task @.current-task.txt
```

### Типичные паттерны использования

#### Паттерн 1: Всегда показывать секцию задачи

```markdown
## Текущая задача

${task:prompt:"Общий обзор без конкретной задачи"}
```

#### Паттерн 2: Секция задачи только при наличии

```markdown
{% if task %}
## Текущая задача

${task}
{% endif %}
```

#### Паттерн 3: Разные промты для разных режимов

```markdown
{% if tag:review %}
${task:prompt:"Проведи code review изменений"}
{% endif %}

{% if tag:debug %}
${task:prompt:"Помоги найти причину бага"}
{% endif %}
```

<!-- lg:endif --> <!-- lg:if TAGSET:template-features:md-placeholders -->
## Вставка обычных Markdown-документов

При составлении LG-контекстов часто есть необходимость вставки уже готовых Markdown-документов, которые изначально не создавались для LG. Такие документы можно вставлять двумя способами.

Способ с использованием отдельной секции:
```yaml
intro:
  extensions: [".md"]
  filters:
    mode: allow
    allow:
      - "/README.md"
```
При таком способе можно использовать [все возможности](markdown.md) Markdown языкового адаптера.

Также существует более просто способ вставки с использованием плейсхолдера `${md:…}`:
```markdown
${md:README}
```

> **Примечание**: Путь указывается относительно директории **текущего скоупа** (директории, содержащей `lg-cfg/`). При вложенных включениях скоуп меняется соответствующим образом.

Плейсхолдер `${md:…}` обладает довольно широкими возможностями.

### Вставка документа из поддиректории

```markdown
${md:docs/markdown}
```

### Вставка документа, помещенного в `lg-cfg/`

```markdown
${md@self:adapters/gen/LIB_README}
```

### Вставка документа из другого скоупа

```markdown
${md@apps/web:web-intro}
```

### Варианты вставки нескольких параграфов

Шаблонизатор производит контекстуальный анализ уровней заголовков, поэтому все данные варианты вставки нескольких параграфов валидны.

**Вариант 1**

~~~markdown
# Listing Generator 

## Расширенная документация

### ${md:docs/templates}

### ${md:docs/markdown}

### ${md:docs/adapters}

## Лицензия
~~~

**Вариант 2**

~~~markdown
# Listing Generator 

## Расширенная документация

### Шаблоны, контексты и каскадные включения

${md:docs/templates}

### Руководство по работе с Markdown

${md:docs/markdown}

### Языковые адаптеры

${md:docs/markdown}

## Лицензия
~~~

**Вариант 3**

~~~markdown
# Listing Generator 

## Расширенная документация

${md:docs/templates}

${md:docs/markdown}

${md:docs/markdown}

## Лицензия
~~~

### Явное переопределение настроек через параметры

```markdown
${md:docs/templates, level:4, strip_h1:false}
```

Это позволит пользователям точно управлять поведением в особых случаях.

### Частичное включение документа

```markdown
${md:docs/api#Authentication}
```

Включение только определённого параграфа документации по заголовку, что полезно для больших документов.

### Массовое добавление документации и поддержка глобов

```markdown
${md:docs/guides/*}  <!-- все руководства -->
```

### Условные включения

```markdown
${md:docs/deployment, if:tag:cloud}
```

Включение документа на основе активных тегов или тегсетов.

<!-- lg:endif --> <!-- lg:if TAGSET:template-features:adaptive -->
## Адаптивные возможности в обычных Markdown-документах

[Подробнее](adaptability.md#использованием-адаптивных-возможностей-в-markdown-адаптере).
<!-- lg:endif -->