# Listing Generator · Адаптивные возможности

## Обзор функциональности

Система адаптивных возможностей для Listing Generator позволяет создавать и использовать различные срезы контекстов на основе наборов режимов и тегов. Эта система обеспечивает гибкую настройку генерируемых контекстов без дублирования конфигурации.

## Ключевые концепции

### Наборы режимов и режимы

**Набор режимов** - группа взаимоисключающих опций, представляющих определенный аспект работы (например, "Способ работы с AI", "Стадия разработки").

**Режим** - конкретная опция внутри набора режимов, активирующая определенные теги и специальные настройки.

### Наборы тегов и теги

**Набор тегов** - группа взаимосвязанных тегов, представляющих определенную категорию (например, "Языки программирования").

**Тег** - атомарный элемент фильтрации, который может быть активирован или деактивирован.

## Структура конфигурации

### Конфигурация режимов

```yaml
# lg-cfg/modes.yaml
mode-sets:
  ai-interaction:
    title: "Способ работы с AI"
    modes:
      ask:
        title: "Спросить"
        description: "Базовый режим вопрос-ответ"
        # Особых тегов и опций нет
      
      agent:
        title: "Агентная работа"
        description: "Режим с инструментами"
        tags: [agent, tools]
        # Возможны некоторые произвольные дополнительные опции
        allow_tools: true
  
  dev-stage:
    title: "Стадия работы над фичей"
    modes:
      planning:
        title: "Планирование"
        tags: [architecture, docs]
      
      development:
        title: "Основная разработка"
      
      testing:
        title: "Написание тестов"
        tags: [tests]
        default_task: "Напиши тесты для текущего функционального блока."
      
      review:
        title: "Кодревью"
        tags: [review]
        default_task: "Проведи code review изменений и дай рекомендации по улучшению."
        # Возможны некоторые произвольные дополнительные опции
        vcs_mode: "branch-changes"

# Включение режимов из дочерних скоупов
include:
  - child1 # Включает child1/lg-cfg/modes.yaml
  - child2 # Включает child2/lg-cfg/modes.yaml
```

## Конфигурация тегов

```yaml
# lg-cfg/tags.yaml
tag-sets:
  language:
    title: "Языки программирования"
    tags:
      python:
        title: "Python"
      typescript:
        title: "TypeScript"
      javascript:
        title: "JavaScript"
  
  code-type:
    title: "Тип кода"
    tags:
      product:
        title: "Продуктовый код"
      tests:
        title: "Тестовый код"
      generated:
        title: "Сгенерированный код"
    
  some-feature-slices:
    title: "Большой функциональный блок"
    tags:
      subfeature_foo:
        title: "Фича №1"
      subfeature_bar:
        title: "Фича №2"
      subfeature_baz:
        title: "Фича №3"

# Глобальные теги (не входят в определенные наборы и обычно переключаются через режимы)
tags:
  agent:
    title: "Агентные возможности"
  review:
    title: "Правила проведения кодревью"
  # ... другие теги

# Включение тегов из дочерних скоупов
include:
  - child1 # Включает child1/lg-cfg/tags.yaml
  - child2 # Включает child2/lg-cfg/tags.yaml
```

Если в текущем репозитории в стартовом `lg-cfg` вообще нет собственных `modes.yaml` и `tags.yaml` файлов, то будет применятся разумная минимальная конфигурация по умолчанию.

## CLI

```bash
# Список наборов режимов со вложенными режимами
# Данных достаточно для формирования UI (комбобоксы)
listing-generator list mode-sets

# Список наборов тегов со вложенными тегами
# Данных достаточно для формирования UI (наборы чекбоксов)
listing-generator list tag-sets

# Рендеринг с указанием режимов
listing-generator render ctx:my-context --mode ai:agent --mode stage:development

# Рендеринг с указанием дополнительных тегов
# В UA теги выбираются через наборы чекбоксов в рамках TAGSET и затем формируют плоский список
listing-generator render ctx:my-context --tags python,minimal

# Комбинированное использование
listing-generator render ctx:my-context --mode ai:agent --mode stage:review --tags python

# Рендеринг с указанием целевой ветки для режима branch-changes
listing-generator render ctx:my-context --mode stage:review --target-branch main
```

## Системные опции режимов

Есть ряд возможностей LG, которые привязаны не к аргументам командной строки и не к конфигурации секций, а именно к дополнительным опциям режимов. То есть они настраиваются в файле `lg-cfg/modes.yaml` и включаются через указание нужного режима.

| Опция                          | Синтаксис в YAML        | Варианты                              | По умолчанию | Описание                                                                                                                                                                                                                |
|--------------------------------|-------------------------|---------------------------------------|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Режимы VCS**                 | `vcs_mode: <вариант>`   | `all \| changes \| branch-changes`    | `all`        | Дополнительные фильтрация файлов в секциях с учетом статуса системы контроля версий:<br/>- **all** — включать все файлы<br/>- **changes** — включать только изменённые в рабочем дереве (staged + unstaged + untracked)<br/>- **branch-changes** — включать файлы изменённые в текущей ветке относительно целевой ветки (указывается через `--target-branch`) |
| **Markdown Code Fencing**      | `code_fence: <bool>`    | `true \| false`                       | `true`       | Автоматическое оборачивание блоков кода в `fenced`-обёртки с указанием языка (\`\`\`python, \`\`\`bash и др.)                                                                                                           |

<!-- lg:if NOT tag:vcs -->
## Условная логика

### Условия в Markdown шаблонах

```markdown
## Документация

{% if tag:docs %}
Подробная документация API...
{% endif %}

{% if TAGSET:language:python %}
### Python-специфичная реализация
${python-impl}
{% endif %}

{% if tag:agent AND NOT tag:minimal %}
### Инструменты агента
${agent-tools}
{% endif %}
```

### Условия в конфигурации секций

```yaml
# lg-cfg/sections.yaml
feature-impl:
  extensions: [".py", ".ts", ".js"]
  filters:
    mode: allow
    allow:
      - "/src/feature/**"
    
    when:
      - condition: "TAGSET:language:python"
        allow:
          - "/src/feature/python/**"
        block:
          - "/src/feature/!(python)/**"
      
      - condition: "tag:tests"
        allow:
          - "**/*_test.py"
          - "**/*.spec.ts"

  python:
    when:
      - condition: "tag:minimal"
        strip_function_bodies: true
      - condition: "tag:docs_only"
        comment_policy: "keep_doc"
```

### Поддерживаемые операторы условий

- `tag:<name>` - активен указанный тег
- `NOT tag:<name>` - указанный тег не активен
- `tag:<name1> AND tag:<name2>` - оба тега активны
- `tag:<name1> OR tag:<name2>` - активен хотя бы один из тегов
- `TAGSET:<set-name>:<tag-name>` - специальный оператор для срезов (разрешительный по умолчанию):
  - Истинно, если ни один тег из набора не активен
  - Истинно, если указанный тег активен
  - Ложно во всех остальных случаях
- `TAGONLY:<set-name>:<tag-name>` - эксклюзивный оператор для срезов (запретительный по умолчанию):
  - Истинно только если указанный тег активен И он единственный активный из набора
  - Ложно во всех остальных случаях

Для работы с федеративными скоупами добавляются дополнительные операторы, которые могут комбинироваться с другими операторами условий.

- `scope:local` - применяется только если рендерится из локального скоупа
- `scope:parent` - применяется при рендере из родительского скоупа

## Задание режимов в шаблонах

Иногда удобно сами режимы принудительно задавать в шаблонах.

```markdown
{% mode dev-stage:development %}
<!-- Это очень важный архитектурных код, поэтому его лучше всегда вставлять полностью, без сужающих тегов -->
<!-- Также мы гарантируем, что даже на кодревью этот код будет вставлен полностью -->
${src-arch}
{% endmode %}

<!-- А рендеринг этой секции уже полностью зависит от выбранного в UI пользователем режима и/или срезов -->
<!-- Пользователь может для этой секции включить опцию `vcs_mode` через режимы -->
${src-feature}
```

<!-- lg:comment:start -->
## Полный справочник возможностей шаблонизатора

### Плейсхолдеры (основные элементы вставки)

| Тип | Синтаксис | Примеры | Описание |
|-----|-----------|---------|----------|
| **Секция** (текущий скоуп) | `${name}` | `${my-section}` | Вставка секции из текущего lg-cfg |
| **Секция** (другой скоуп) | `${@origin:name}` | `${@apps/web:web-src}` | Секция из другого lg-cfg в репозитории |
| **Секция** (сложный путь) | `${@[origin]:name}` | `${@[apps/web:v1]:src}` | Для путей с двоеточиями внутри `origin` |
| **Шаблон** (текущий скоуп) | `${tpl:name}` | `${tpl:common/intro}` | Шаблон из текущего lg-cfg |
| **Шаблон** (другой скоуп) | `${tpl@origin:name}` | `${tpl@libs/math:utils}` | Шаблон из другого модуля |
| **Шаблон** (сложный путь) | `${tpl@[origin]:name}` | `${tpl@[libs/math:v2]:intro}` | Для путей с двоеточиями |
| **Контекст** (текущий скоуп) | `${ctx:name}` | `${ctx:api/review}` | Контекст из текущего lg-cfg |
| **Контекст** (другой скоуп) | `${ctx@origin:name}` | `${ctx@services/auth:guide}` | Контекст из другого модуля |
| **Контекст** (сложный путь) | `${ctx@[origin]:name}` | `${ctx@[services/auth:v1]:intro}` | Для путей с двоеточиями |

### Условные конструкции

| Конструкция | Синтаксис | Примеры | Описание |
|-------------|-----------|---------|----------|
| **If-блок** | `{% if условие %}...{% endif %}` | `{% if tag:debug %}...{% endif %}` | Базовая условная конструкция |
| **If-else** | `{% if условие %}...{% else %}...{% endif %}` | `{% if tag:python %}...{% else %}...{% endif %}` | Условие с альтернативой |
| **If-elif-else** | `{% if условие1 %}...{% elif условие2 %}...{% else %}...{% endif %}` | `{% if tag:python %}...{% elif tag:javascript %}...{% else %}...{% endif %}` | Цепочка условий |

### Операторы условий

| Оператор | Синтаксис | Примеры | Описание |
|----------|-----------|---------|----------|
| **Тег** | `tag:имя_тега` | `tag:python`, `tag:docs` | Проверяет активность тега |
| **Набор тегов** | `TAGSET:набор:тег` | `TAGSET:language:python` | Особая проверка для срезов набора тегов |
| **Отрицание** | `NOT условие` | `NOT tag:minimal` | Инвертирует условие |
| **И** | `условие1 AND условие2` | `tag:python AND tag:tests` | Истинно, если оба условия истинны |
| **ИЛИ** | `условие1 OR условие2` | `tag:python OR tag:javascript` | Истинно, если хотя бы одно условие истинно |
| **Скобки** | `(условие)` | `(tag:python OR tag:js) AND tag:tests` | Группировка для задания приоритета |
| **Скоуп** | `scope:тип` | `scope:local`, `scope:parent` | Проверка типа скоупа (локальный/родительский) |

### Режимные блоки

| Конструкция | Синтаксис | Примеры | Описание |
|-------------|-----------|---------|----------|
| **Режимный блок** | `{% mode набор:режим %}...{% endmode %}` | `{% mode dev-stage:review %}...{% endmode %}` | Переключает режим для вложенного содержимого |

### Комментарии

| Конструкция | Синтаксис | Примеры | Описание |
|-------------|-----------|---------|----------|
| **Шаблонный комментарий** | `{# текст #}` | `{# Это не будет в результате #}` | Удаляется при обработке |
| **HTML-комментарий** | `<!-- текст -->` | `<!-- Примечание -->` | Проходит в итоговый результат |
<!-- lg:comment:end -->

---
<!-- lg:raw:start -->
## Использованием адаптивных возможностей в Markdown-адаптере

Markdown-адаптер также имеет поддержку условных конструкции на базе HTML-комментариев. Это позволяет использовать адаптивные возможности в обычных Markdown-документах без нарушения их читабельности в сторонних просмотрщиках.

### Синтаксис условных конструкций

Синтаксис основан на специальных HTML-комментариях с префиксами, указывающими на их роль:

#### Условные блоки

```markdown
<!-- lg:if tag:python -->
Этот текст будет видим только при активном теге python.
<!-- lg:endif -->

<!-- lg:if tag:debug -->
Отладочная информация
<!-- lg:else -->
Обычное содержимое
<!-- lg:endif -->

<!-- lg:if TAGSET:language:typescript -->
TypeScript-специфичный контент
<!-- lg:elif TAGSET:language:python -->
Python-специфичный контент
<!-- lg:else -->
Контент для других языков
<!-- lg:endif -->
```

#### Комментарии-инструкции

```markdown
<!-- lg:comment:start -->
Этот текст БУДЕТ ВИДИМ в Markdown-просмотрщиках,
но исключится при обработке LG-инструментом.
<!-- lg:comment:end -->
```

### Пример использования

#### Конфигурация в YAML

```yaml
docs:
  extensions: [".md"]
  markdown:
    max_heading_level: 2
    enable_templating: true  # Включение новой функциональности
    drop:
      sections:
        - match: { kind: text, pattern: "Installation" }
      frontmatter: true
```

#### Пример Markdown-документа с условиями

~~~markdown
# Документация API

## Введение

Это общая документация API.

<!-- lg:if tag:python -->
## Python-клиент

```python
import api_client

client = api_client.Client("apikey")
response = client.get_data()
```
<!-- lg:endif -->

<!-- lg:if tag:javascript -->
## JavaScript-клиент

```javascript
const client = new ApiClient("apikey");
const response = await client.getData();
```
<!-- lg:endif -->

<!-- lg:if tag:debug -->
## Отладка

Информация для отладки...
<!-- lg:else -->
## Использование

Стандартная инструкция по использованию...
<!-- lg:endif -->


<!-- lg:comment:start -->
TODO: Добавить документацию по новым методам API
Эта заметка не попадет в итоговый результат
<!-- lg:comment:end -->
~~~
<!-- lg:raw:end -->
<!-- lg:endif -->