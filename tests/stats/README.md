# Тестовая инфраструктура для статистики и токенизации

## Обзор

Создана полная инфраструктура для тестирования подсистемы статистики 3. **Расширяемость**: легко добавить новые токенизаторы
4. **CI-friendly**: работает как с моделями, так и без них
5. **Отсутствие хардкода**: использование констант из infrastructureокенизации в Listing Generator. Инфраструктура позволяет:

- Тестировать различные токенизаторы без скачивания моделей при каждом запуске
- Проверять корректность кеширования моделей
- Сравнивать точность разных токенизаторов
- Проверять расчет статистики и оптимизации токенов

## Структура

```
tests/
└── stats/                           # Новый тестовый пакет
    ├── __init__.py                  # Описание пакета
    ├── conftest.py                  # Фикстуры и mock для HF Hub
    ├── SETUP.md                     # Инструкции по настройке
    ├── download_test_models.py      # Скрипт скачивания моделей
    │
    ├── resources/                   # Предскачанные модели
    │   ├── README.md                # Инструкции по ручному скачиванию
    │   ├── models_manifest.json     # Манифест моделей
    │   ├── tokenizers/              # HuggingFace tokenizers
    │   │   └── gpt2/
    │   │       └── tokenizer.json   # (скачивается отдельно)
    │   └── sentencepiece/           # SentencePiece модели
    │       └── google--gemma-2-2b/
    │           └── tokenizer.model  # (скачивается отдельно)
    │
    ├── test_model_cache.py          # Тесты кеширования моделей
    ├── test_tokenizer_comparison.py # Сравнения токенизаторов
    └── test_statistics.py           # Основные тесты статистики
```

## Ключевые компоненты

### 1. Mock для HuggingFace Hub (`conftest.py`)

Фикстура `mock_hf_hub` подменяет `hf_hub_download` на версию, которая:
- Использует предскачанные модели из `resources/`
- Имитирует поведение реального HF Hub
- Отслеживает количество "скачиваний" для тестов кеша
- Автоматически активируется для всех тестов в пакете

### 2. Фикстуры токенизаторов

- `tiktoken_service` - всегда доступен (встроенный)
- `hf_tokenizer_service` - требует модели в resources/
- `sp_tokenizer_service` - требует модели в resources/
- `sample_texts` - набор тестовых текстов для сравнений

### 3. Тесты

#### `test_model_cache.py`
Проверяет что `lg.stats.tokenizers.model_cache.ModelCache`:
- Корректно создает структуру кеша
- Безопасно обрабатывает имена с `/` (преобразует в `--`)
- Правильно определяет наличие моделей в кеше
- Список закешированных моделей корректен
- Кеш переживает перезапуски программы
- Адаптеры используют кеш и не скачивают модели повторно

#### `test_tokenizer_comparison.py`
Проверяет что:
- Все токенизаторы корректно считают токены
- Разные токенизаторы дают разные результаты
- Результаты стабильны для одного текста
- Токенизация эффективна для кода и смешанного контента
- Специальные символы обрабатываются корректно
- Разница между токенизаторами в разумных пределах
- Кеширование токенов работает правильно

#### `test_statistics.py`
Переписанные тесты из старого `test_stats.py`:
- Markdown оптимизации (удаление H1, экономия токенов)
- Оверхеды рендеринга (fences, file markers)
- Оверхеды шаблонов контекстов
- Распределение долей (shares) в промте
- Агрегация метаданных
- Статистика на уровне отдельных файлов

## Использование

### Быстрый старт (только tiktoken)

```bash
pytest tests/stats/
```

Тесты автоматически используют tiktoken (встроенный) когда HF/SP модели недоступны.

### Полное окружение

```bash
# 1. Установить зависимости
pip install tokenizers sentencepiece huggingface-hub

# 2. Скачать тестовые модели
python tests/stats/download_test_models.py

# 3. Запустить все тесты
pytest tests/stats/ -v
```

### CI/CD

В CI окружении (без моделей):
- Тесты используют только tiktoken
- Тесты, требующие HF/SP, пропускаются
- Базовая функциональность полностью тестируется

Для полного тестирования:
- Скачать модели один раз
- Закешировать `tests/stats/resources/`
- Переиспользовать в последующих запусках

## Важные изменения

### Удалено
- `tests/test_stats.py` (старый файл, заменен на `tests/stats/test_statistics.py`)

### Добавлено
- `tests/stats/` - новый пакет тестов
- Mock для HuggingFace Hub без реального скачивания
- Скрипт автоматического скачивания моделей
- Подробная документация по настройке
- Использование констант из `cli_utils` для избежания хардкода

### Обновлено
- Старые тесты статистики полностью переписаны под новую инфраструктуру
- Фикстуры используют дефолтные значения из инфраструктуры

## Преимущества новой инфраструктуры

1. **Быстрые тесты**: модели не скачиваются при каждом запуске
2. **Офлайн работа**: тесты работают без интернета (после первичной настройки)
3. **Детерминизм**: одни и те же модели в каждом запуске
4. **Расширяемость**: легко добавить новые токенизаторы
5. **CI-friendly**: работает как с моделями, так и без них
6. **Переиспользование**: утилиты доступны во всех тестах

## Следующие шаги

Для завершения настройки:

1. Скачать тестовые модели:
   ```bash
   python tests/stats/download_test_models.py
   ```

2. Запустить тесты для проверки:
   ```bash
   pytest tests/stats/ -v
   ```

3. Убедиться что кеширование работает:
   - Первый запуск: "скачивание" моделей
   - Последующие запуски: "Loading from cache"

4. (Опционально) Добавить в CI:
   - Кеширование `tests/stats/resources/`
   - Или использование только tiktoken тестов
