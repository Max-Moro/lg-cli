# Плагин адаптивных возможностей для шаблонизатора V2

## Статус: В разработке (частично функционален)

Этот плагин реализует поддержку адаптивных возможностей в модульном шаблонизаторе V2:
- Условные блоки `{% if %}...{% elif %}...{% else %}...{% endif %}`
- Режимные блоки `{% mode modeset:mode %}...{% endmode %}`  
- Комментарии `{# ... #}`

## Текущее состояние

### ✅ Реализовано:
- Токенизация директив (`{%`, `%}`) и комментариев (`{#`, `#}`)
- AST узлы для всех адаптивных конструкций
- Обработчики (процессоры) для вычисления условий и управления режимами
- Базовая структура правил парсинга

### ⚠️ Требует доработки:

**Парсинг блочных директив** - текущая реализация парсинга блоков `{% if %}...{% endif %}` не работает корректно из-за архитектурных отличий модульного парсера от монолитного.

**Проблема:** В старом парсере функция `_parse_if_directive` сама парсит всё тело блока до `{% endif %}`, используя рекурсивный вызов парсера. В модульной архитектуре каждое правило парсинга обрабатывает только свой токен/конструкцию, а основной парсер собирает результаты.

**Возможные решения:**

1. **Стековый подход** (как в старом парсере):
   - Правила парсинга получают доступ к основному парсеру через handlers
   - При встрече `{% if %}` сохраняют состояние и продолжают парсить до `{% endif %}`
   - Требует расширения интерфейса handlers

2. **Узлы-маркеры** (более модульный подход):
   - Создавать отдельные узлы для открывающих/закрывающих директив
   - Основной парсер собирает узлы между маркерами в блоки
   - Требует пост-обработки AST для сборки блоков

3. **Двухпроходный парсинг:**
   - Первый проход: создать плоский AST с узлами директив
   - Второй проход: собрать блоки из плоского AST

## Файлы

- `nodes.py` - AST узлы (ConditionalBlockNode, ModeBlockNode, CommentNode)
- `tokens.py` - Спецификации токенов для директив и комментариев
- `parser_rules.py` - Правила парсинга (требует доработки)
- `processor.py` - Обработчики для вычисления условий и управления режимами
- `plugin.py` - Главный плагин, регистрирующий все компоненты

## Использование

Плагин автоматически регистрируется в `create_v2_template_processor()` и не требует ручной настройки.

## Следующие шаги

1. Выбрать подход к парсингу блочных конструкций
2. Реализовать выбранный подход
3. Добавить тесты для всех адаптивных возможностей
4. Обеспечить полную совместимость со старым шаблонизатором

