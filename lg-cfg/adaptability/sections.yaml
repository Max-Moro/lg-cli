src:
  extensions: [".py", ".toml", ".json"]
  filters:
    mode: allow
    allow:
      - "/pyproject.toml"
      - "/lg/"
    children:
      lg:
        mode: allow
        allow:
          - "/cli.py"
          - "/types.py"
          - "/run_context.py"
          - "/engine.py"
          - "/section_processor.py"
          - "/adaptive/"
          - "/template/"
          - "/addressing/"
          - "/section/"
        children:
          # Template engine - only core files for adaptive system
          template:
            mode: allow
            allow:
              # Core for adaptive
              - "/context.py"
              - "/evaluator.py"
              - "/frontmatter.py"
              - "/processor.py"
              - "/adaptive/"
              - "/analysis/"
              # Essential infrastructure (signatures only via targets)
              - "/common.py"
              - "/registry.py"
              - "/base.py"
              - "/handlers.py"
              - "/types.py"
              - "/nodes.py"
            block:
              # Exclude implementation details
              - "/lexer.py"
              - "/parser.py"
              - "/tokens.py"
              - "/protocols.py"
              # Exclude common placeholders - not related to adaptive modes/tags
              - "/common_placeholders/"
              - "/md_placeholders/"
              - "/task_placeholder/"
          # Section service - needed for extends
          section:
            mode: allow
            allow:
              - "/model.py"
              - "/service.py"
              - "/index.py"
            block:
              - "/paths.py"
          # Addressing - only types and context
          addressing:
            mode: allow
            allow:
              - "/types.py"
              - "/context.py"
              - "/configs.py"
              - "/errors.py"
            block:
              # Block resolvers implementation details
              - "/file_resolver.py"
              - "/section_resolver.py"
              - "/parser.py"

  # Graduated optimization following budget escalation order:
  #   Level 1: imports_external + literals (base for all files)
  #   Level 2: + comments keep_doc + imports_all
  #   Level 3: + private_bodies (keep_public)
  #   Level 4: + public_bodies (strip_all)
  # All optimizations disabled in review mode (tag:review) for full code visibility.

  # Level 1 (global base): lightest optimization for all Python files
  python:
    when:
      - condition: "NOT tag:review"
        imports:
          policy: "strip_external"
        literals:
          max_tokens: 100

  targets:
    # Level 2: context/type definition files — readable logic, stripped noise
    - match:
        - "/lg/run_context.py"
        - "/lg/types.py"
        - "/lg/section/model.py"
        - "/lg/section_processor.py"
        - "/lg/template/adaptive/processor_rules.py"
      python:
        when:
          - condition: "NOT tag:review"
            comment_policy: "keep_doc"
            imports:
              policy: "strip_all"

    # Level 3: infrastructure — public API visible, private bodies stripped
    - match:
        - "/lg/engine.py"
        - "/lg/template/processor.py"
        - "/lg/template/registry.py"
        - "/lg/template/base.py"
        - "/lg/template/handlers.py"
        - "/lg/template/types.py"
        - "/lg/addressing/context.py"
        - "/lg/addressing/types.py"
        - "/lg/section/service.py"
        - "/lg/section/index.py"
      python:
        when:
          - condition: "NOT tag:review"
            comment_policy: "keep_doc"
            imports:
              policy: "strip_all"
            strip_function_bodies:
              policy: "keep_public"

    # Level 4: peripheral — only signatures needed
    - match:
        - "/lg/cli.py"
        - "/lg/template/adaptive/parser_rules.py"
        - "/lg/template/analysis/section_collector.py"
        - "/lg/adaptive/extends_resolver.py"
        - "/lg/adaptive/context_resolver.py"
        - "/lg/adaptive/listing.py"
      python:
        when:
          - condition: "NOT tag:review"
            comment_policy: "keep_doc"
            imports:
              policy: "strip_all"
            strip_function_bodies: true
