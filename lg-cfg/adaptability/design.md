# Дизайн-документ: Listing Generator · Адаптивные возможности

## Обзор функциональности

Система адаптивных возможностей для Listing Generator позволяет создавать и использовать различные срезы контекстов на основе наборов режимов и тегов. Эта система обеспечивает гибкую настройку генерируемых контекстов без дублирования конфигурации.

## Ключевые концепции

### Наборы режимов и режимы

**Набор режимов** - группа взаимоисключающих опций, представляющих определенный аспект работы (например, "Способ работы с AI", "Стадия разработки").

**Режим** - конкретная опция внутри набора режимов, активирующая определенные теги и специальные настройки.

### Наборы тегов и теги

**Набор тегов** - группа взаимосвязанных тегов, представляющих определенную категорию (например, "Языки программирования").

**Тег** - атомарный элемент фильтрации, который может быть активирован или деактивирован.

## Структура конфигурации

### Конфигурация режимов

```yaml
# lg-cfg/modes.yaml
mode-sets:
  ai-interaction:
    title: "Способ работы с AI"
    modes:
      ask:
        title: "Спросить"
        description: "Базовый режим вопрос-ответ"
        # Особых тегов и опций нет
      
      agent:
        title: "Агентная работа"
        description: "Режим с инструментами"
        tags: [agent, tools]
        # Возможны некоторые произвольные дополнительные опции
        allow_tools: true
  
  dev-stage:
    title: "Стадия работы над фичей"
    modes:
      planning:
        title: "Планирование"
        tags: [architecture, docs]
      
      development:
        title: "Основная разработка"
        # Особых тегов и опций нет
      
      testing:
        title: "Написание тестов"
        tags: [tests]
      
      review:
        title: "Кодревью"
        tags: [review]
        # Возможны некоторые произвольные дополнительные опции
        vcs_mode: "changes" # В данной ситуаии сюда переезжает работа старого аргумента `--mode changes`

# Включение режимов из дочерних скоупов
include:
  - child1 # Включает child1/lg-cfg/modes.yaml
  - child2 # Включает child2/lg-cfg/modes.yaml
```

### Конфигурация тегов

```yaml
# lg-cfg/tags.yaml
tag-sets:
  language:
    title: "Языки программирования"
    tags:
      python:
        title: "Python"
      typescript:
        title: "TypeScript"
      javascript:
        title: "JavaScript"
  
  code-type:
    title: "Тип кода"
    tags:
      product:
        title: "Продуктовый код"
      tests:
        title: "Тестовый код"
      generated:
        title: "Сгенерированный код"
    
  some-feature-slices:
    title: "Большой функциональный блок"
    tags:
      subfeature_foo:
        title: "Фича №1"
      subfeature_bar:
        title: "Фича №2"
      subfeature_baz:
        title: "Фича №3"

# Глобальные теги (не входят в определенные наборы и обычно переключаются через режимы)
tags:
  agent:
    title: "Агентные возможности"
  review:
    title: "Правила проведения кодревью"
  # ... другие теги

# Включение тегов из дочерних скоупов
include:
  - child1 # Включает child1/lg-cfg/tags.yaml
  - child2 # Включает child2/lg-cfg/tags.yaml
```

### Правила объединения скоупов

При включении конфигураций будут применяться следующие правила:

1. **Для наборов режимов (mode-sets)**:
   - Если набор режимов с одинаковым именем определен как в родительском, так и в дочернем скоупе, приоритет имеет родительская конфигурация
   - Индивидуальные режимы внутри набора объединяются, с приоритетом родительских режимов

2. **Для наборов тегов (tag-sets)**:
   - Наборы тегов с одинаковыми именами объединяются
   - Теги с одинаковыми именами в одном наборе используют определение из родительского скоупа


## Условная логика

### Условия в Markdown шаблонах

Система шаблонизации похожа на ту, которая используеся в движках **Nunjucks** и **Liquid**.

```markdown
## Документация

{% if tag:docs %}
Подробная документация API...
{% endif %}

{% if TAGSET:language:python %}
### Python-специфичная реализация
${python-impl}
{% endif %}

{% if tag:agent AND NOT tag:minimal %}
### Инструменты агента
${agent-tools}
{% endif %}
```

### Условия в конфигурации секций

```yaml
# lg-cfg/sections.yaml
feature-impl:
  extensions: [".py", ".ts", ".js"]
  filters:
    mode: allow
    allow:
      - "/src/feature/**"
    
    when:
      - condition: "TAGSET:language:python"
        allow:
          - "/src/feature/python/**"
        block:
          - "/src/feature/!(python)/**"
      
      - condition: "tag:tests"
        allow:
          - "**/*_test.py"
          - "**/*.spec.ts"

  python:
    when:
      - condition: "tag:minimal"
        strip_function_bodies: true
      - condition: "tag:docs_only"
        comment_policy: "keep_doc"
```

### Поддерживаемые операторы условий

- `tag:<name>` - активен указанный тег
- `NOT tag:<name>` - указанный тег не активен
- `tag:<name1> AND tag:<name2>` - оба тега активны
- `tag:<name1> OR tag:<name2>` - активен хотя бы один из тегов
- `TAGSET:<set-name>:<tag-name>` - специальный оператор для срезов:
  - Истинно, если ни один тег из набора не активен
  - Истинно, если указанный тег активен
  - Ложно во всех остальных случаях

### Федеративная осведомлённость

Для работы с федеративными скоупами добавляются дополнительные операторы, которые могут комбинироваться с другими операторами условий.

- `scope:local` - применяется только если рендерится из локального скоупа
- `scope:parent` - применяется при рендере из родительского скоупа


## CLI реализация

### Основные команды

```bash
# Список наборов режимов со вложенными режимами
# Данных достаточно для формирования UI (комбобоксы)
lg list mode-sets

# Список наборов тегов со вложенными тегами
# Данных достаточно для формирования UI (наборы чекбоксов)
lg list tag-sets

# Рендеринг с указанием режимов
lg render ctx:my-context --mode ai:agent --mode stage:development

# Рендеринг с указанием дополнительных тегов
# В UA теги выбираются через наборы чекбоксов в рамках TAGSET и затем формируют плоский список
lg render ctx:my-context --tags python,minimal

# Комбинированное использование
lg render ctx:my-context --mode ai:agent --mode stage:review --tags python
```

### Логика вычисления активных тегов

1. Собираются теги из всех активных режимов
2. Добавляются явно указанные теги из аргумента `--tags`
3. Результирующий набор тегов используется для вычисления условий
