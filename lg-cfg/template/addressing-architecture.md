# Архитектура системы адресации в шаблонах LG

> Этот документ описывает архитектуру модуля адресации путей в шаблонизаторе Listing Generator.

---

## 1. Обзор

### 1.1. Цели

1. **Консолидация** — вся логика адресации в одном пакете `lg/template/addressing/`
2. **Расширяемость** — легко добавлять новые типы путей и правила
3. **Тестируемость** — изолированное тестирование логики адресации
4. **Понятность** — чёткое разделение ответственности между компонентами

---

## 2. Структура пакета

```
lg/template/addressing/
├─ __init__.py          # Публичный API пакета
├─ types.py             # Типы данных и константы
├─ parser.py            # Парсинг строковых путей
├─ resolver.py          # Резолвинг путей в абсолютные
├─ context.py           # Контекст адресации (стек директорий)
└─ errors.py            # Специализированные исключения
```

---

## 3. Компоненты

> **Реализация**: Пакет `lg/template/addressing/` полностью реализован. См. исходный код для деталей.

| Модуль | Описание |
|--------|----------|
| `types.py` | `ResourceKind`, `ParsedPath`, `ResolvedPath`, `DirectoryContext` |
| `parser.py` | `PathParser` — парсинг строковых путей |
| `resolver.py` | `PathResolver` — резолвинг путей в абсолютные |
| `context.py` | `AddressingContext` — стек контекста директорий |
| `errors.py` | `PathParseError`, `PathResolutionError`, `ScopeNotFoundError`, `ResourceNotFoundError` |
| `__init__.py` | Публичный API пакета |

---

## 4. Диаграмма потока данных

```
┌─────────────────────────────────────────────────────────────────┐
│                      Плейсхолдер в шаблоне                      │
│                   ${tpl:../common/header}                       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                        PathParser                                │
│                                                                  │
│  Вход: "../common/header", kind=TEMPLATE                         │
│  Выход: ParsedPath(                                              │
│           kind=TEMPLATE,                                         │
│           origin=None,                                           │
│           origin_explicit=False,                                 │
│           path="../common/header",                               │
│           is_absolute=False                                      │
│         )                                                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                       PathResolver                               │
│                                                                  │
│  Вход: ParsedPath + AddressingContext(current_dir="adapters")   │
│                                                                  │
│  1. Скоуп: origin=None → из контекста → "self"                  │
│  2. База: is_absolute=False → current_dir="adapters"            │
│  3. Путь: "adapters" + "../common/header" → "common/header"     │
│  4. Расширение: → "common/header.tpl.md"                        │
│  5. Проверка: lg-cfg/common/header.tpl.md ✓                     │
│                                                                  │
│  Выход: ResolvedPath(                                            │
│           kind=TEMPLATE,                                         │
│           scope_dir=/repo,                                       │
│           scope_rel="",                                          │
│           cfg_root=/repo/lg-cfg,                                 │
│           resource_path=/repo/lg-cfg/common/header.tpl.md,      │
│           resource_rel="common/header.tpl.md"                   │
│         )                                                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Загрузка и обработка файла                     │
│                                                                  │
│  load_template_from(cfg_root, "common/header")                  │
│  → парсинг → резолвинг вложенных → рендеринг                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. Тестирование

> **Реализация**: Тесты в `tests/template/addressing/` (77 тестов). См. исходный код.

Покрытие:
- Парсинг путей (простые, абсолютные, с `../`, с origin)
- Резолвинг (скоупы, относительные пути, валидация границ)
- Стек контекста (push/pop, вложенные включения)
- Обработка ошибок