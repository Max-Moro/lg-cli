# Дорожная карта рефакторинга системы адресации

> Этот документ описывает последовательность этапов рефакторинга системы адресации в шаблонизаторе LG.

---

## Общие принципы

- **Разрушающий рефакторинг** — обратная совместимость не обеспечивается
- **Стабилизация в конце** — система будет сломана до завершения всех этапов

---

## Этап 1: Создание пакета addressing/ ✓ ЗАВЕРШЁН

Создан изолированный пакет `lg/template/addressing/` с полной реализацией логики адресации. Unit-тесты в `tests/template/addressing/` (77 тестов, 100% проходят).

---

## Этап 2: Интеграция и замена существующей логики ✓ ЗАВЕРШЁН

Интегрирован пакет `lg/template/addressing/` в систему шаблонизации. Изменённые модули:
- `lg/template/context.py` — добавлен `AddressingContext`, `resolve_path()`, удалён `TemplateState.origin`
- `lg/template/common.py` — удалены `Locator`, `parse_locator()`, `resolve_cfg_root()`, `merge_origins()`
- `lg/template/common_placeholders/resolver.py` — делегирует резолвинг в `template_ctx.resolve_path()`
- `lg/template/md_placeholders/plugin.py` — использует новый API адресации

Система компилируется. Тесты требуют актуализации (Этап 3).

---

## Этап 3: Актуализация тестов и стабилизация

### Цель

Привести все тесты в соответствие с новой системой адресации и обеспечить полное покрытие.

### Входные данные

- Интегрированная система из Этапа 2
- Падающие тесты
- Требования из `addressing-requirements.md`

### Задачи

1. Актуализировать существующие тесты плейсхолдеров:
   - `tests/common_placeholders/` — обновить пути и ожидания
   - `tests/md_placeholders/` — обновить под новую логику md с @ и без
   - Исправить фикстуры и хелперы в `conftest.py`

2. Актуализировать интеграционные тесты:
   - Тесты в `tests/` корне, использующие шаблонизацию
   - Проверить федеративные сценарии (несколько lg-cfg)

3. Написать новые тесты для относительных путей:
   - Тесты `../` в разных контекстах
   - Тесты абсолютных путей с `/`
   - Тесты вложенных включений с изменением current_dir
   - Тесты ошибок при выходе за пределы lg-cfg/

4. Проверить и обновить тестовую инфраструктуру:
   - `tests/infrastructure/` — утилиты для создания файлов и рендеринга
   - Убедиться что хелперы работают с новой системой

5. Финальная проверка:
   - Запустить полный набор тестов
   - Исправить все падения
   - Убедиться в отсутствии регрессий

### Критерии завершения

- Все тесты проходят
- Новая функциональность (относительные пути, `../`) покрыта тестами
- Система стабильна и готова к использованию

### Примечания

- Это самый объёмный этап по количеству изменений в тестах
- Возможно потребуется итеративная работа: исправить → запустить → исправить
- При обнаружении багов в логике — исправлять в пакете addressing/

---

## Порядок выполнения

```
Этап 1          Этап 2              Этап 3
────────────    ────────────────    ──────────────────────
Создание        Интеграция          Стабилизация
пакета          с системой          и тесты

[addressing/]   [TemplateContext]   [tests/]
    │           [Resolvers]             │
    │           [Plugins]               │
    │           [common.py]             │
    ▼               ▼                   ▼
Изолированные   Система             Все тесты
тесты проходят  компилируется       проходят
```

---

## Контрольные точки

После каждого этапа — WIP коммит с описанием состояния:

1. После Этапа 1: `WIP(template): implement addressing package`
2. После Этапа 2: `WIP(template): integrate addressing into template system`
3. После Этапа 3: `feat(template): complete addressing refactoring with relative paths`