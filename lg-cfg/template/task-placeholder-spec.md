# ТЗ: Task Context Field — CLI Implementation

## Обзор

Добавление поддержки динамического контекста текущей задачи через CLI-аргумент `--task` и специальный плейсхолдер `${task}` в шаблонах.

## Цель

Позволить пользователям добавлять финальные инструкции и описание текущей задачи к сгенерированному контексту без необходимости редактирования файлов шаблонов.

---

## 1. CLI Аргумент `--task`

### Синтаксис

```bash
lg render ctx:dev --task "Описание текущей задачи"
lg report ctx:dev --task "Описание текущей задачи"
```

### Варианты использования

#### 1.1 Прямая строка
```bash
lg render ctx:dev --task "Реализовать кеширование результатов"
```

#### 1.2 Многострочный текст через stdin
```bash
echo -e "Задача:\n- Исправить баг #123\n- Добавить тесты" | lg render ctx:dev --task -
```

#### 1.3 Из файла
```bash
lg render ctx:dev --task @.current-task.txt
```

### Поведение

- Если `--task` не указан, плейсхолдер `${task}` рендерится пустой строкой
- Если указан `--task -`, читать из stdin до EOF
- Если указан `--task @path`, читать содержимое файла
- Пустая строка эквивалентна отсутствию аргумента

---

## 2. Плейсхолдер `${task}` в шаблонах

### 2.1 Простой плейсхолдер

**Синтаксис:**
```markdown
${task}
```

**Поведение:**
- Если `--task` задан и непустой → подставляется значение как есть
- Если `--task` пустой или не задан → подставляется пустая строка (не удаляется строка, просто пустое значение)

**Пример шаблона:**
```markdown
# Контекст разработки

${tpl:intro}
${src-core}

## Текущая задача

${task}
```

**Результат без --task:**
```markdown
# Контекст разработки

[содержимое intro]
[содержимое src-core]

## Текущая задача


```

**Результат с --task:**
```markdown
# Контекст разработки

[содержимое intro]
[содержимое src-core]

## Текущая задача

Реализовать кеширование результатов
```

### 2.2 Плейсхолдер с дефолтным значением

**Синтаксис:**
```markdown
${task:prompt:"Дефолтный текст"}
```

**Поведение:**
- Если `--task` задан и непустой → подставляется значение из аргумента
- Если `--task` пустой или не задан → подставляется дефолтное значение из `prompt:`

**Пример:**
```markdown
${task:prompt:"Ничего пока делать не нужно. Просто подтверди, что ты дочитал досюда."}
```

**Результат без --task:**
```markdown
Ничего пока делать не нужно. Просто подтверди, что ты дочитал досюда.
```

**Результат с --task "Fix bug #123":**
```markdown
Fix bug #123
```

### 2.3 Синтаксис дефолтного значения

Формат: `${task:prompt:"текст"}`

**Правила парсинга:**
- Ключевое слово `prompt:` обязательно
- Значение заключено в двойные кавычки `"`
- Внутри строки поддерживаются escape-последовательности: `\"`, `\\`, `\n`
- Пробелы вокруг `prompt:` игнорируются

**Примеры валидных форм:**
```markdown
${task:prompt:"Simple text"}
${task:prompt: "Text with spaces"  }
${task:prompt:"Text with \"quotes\""}
${task:prompt:"Multiline\ntext\nhere"}
```

---

## 3. Условные конструкции

### 3.1 Проверка наличия task

**Синтаксис:**
```markdown
{% if task %}
содержимое
{% endif %}
```

**Поведение:**
- Блок включается, только если `--task` задан и непустой
- Поддерживает вложенность с другими условиями через `AND`, `OR`, `NOT`

**Пример:**
```markdown
# Контекст разработки

${tpl:intro}
${src-core}

{% if task %}
## Описание текущей задачи

${task}
{% endif %}
```

**Результат без --task:**
```markdown
# Контекст разработки

[содержимое intro]
[содержимое src-core]
```

**Результат с --task:**
```markdown
# Контекст разработки

[содержимое intro]
[содержимое src-core]

## Описание текущей задачи

Реализовать кеширование результатов
```

### 3.2 Комбинирование условий

```markdown
{% if task AND tag:review %}
## Задача для ревью

${task}
{% endif %}

{% if NOT task %}
_Конкретная задача не указана. Общий обзор:_
{% endif %}
```

---

## 5. Обратная совместимость

- Старые шаблоны без `${task}` продолжают работать как прежде
- `--task` опционален, его отсутствие не ломает существующие команды
- Плейсхолдер `${task}` в шаблонах игнорируется, если аргумент не передан
