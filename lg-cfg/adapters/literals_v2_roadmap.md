# Дорожная карта: Literal Optimization (целевое состояние «v2»)

> Рабочий код перерабатывается в текущем каталоге. Параллельных веток и совместимости со старой моделью не будет.

## Этапы (после каждого этапа код собирается для всех 10 языков)

1) Новая модель дескриптора (единый шаг для всех языков)  
- Переписать `lg/adapters/optimizations/literals/descriptor.py`: добавить флаги синтаксиса и групповые профили (strings/raw/interp, seq, map, factory, block_init, ast_seq).  
- В каждом `lg/adapters/<lang>/literals.py` заменить паттерны на профильную конфигурацию; удалить старые поля/хаки.  
- В адаптерах заменить вызовы на новый `create_literal_descriptor` (без ветвления v1/v2).  
- Удалить старые вспомогательные структуры дескриптора.

2) Ввод `processing/pipeline.py` как единственной входной точки  
- Создать `lg/adapters/optimizations/literals/processing/pipeline.py` и перенаправить вызовы адаптеров на него.  
- Временно проксировать старые функции из `core.py`/`handler.py` в pipeline, чтобы сохранить сборку.

3) Вынос парсинга  
- Из `handler.py`/`core.py` перенести разбор литералов в новый `processing/parser.py`: работа с Tree-sitter нодами, извлечение текста/границ, без бюджета и плейсхолдеров.  
- Оставить в старых файлах только прокладки к parser.

4) Вынос бюджетного выбора  
- Из существующего `selector.py`/`handler.py` вынести выбор по бюджету в `processing/selector.py`: логика Selection/DFSSelection без форматирования.  
- Старые вызовы в `handler.py` заменить на обращения к новому selector.

5) Вынос форматирования и плейсхолдеров  
- Из `formatter.py`/`handler.py` выделить форматирование в `processing/formatter.py`: построение итогового текста, вставка плейсхолдеров/комментариев.  
- Убрать генерацию плейсхолдеров из других слоёв, оставить вызов нового formatter.

6) Компонент Interpolation  
- Создать `components/interpolation.py`: правила границ/делимитеров интерполяции, корректировка тримминга строк.  
- Удалить дублирующие проверки интерполяции из parser/formatter и из языковых хаков; подключить через pipeline.

7) Компонент AST sequence  
- Создать `components/ast_sequence.py` для последовательностей без разделителей (конкатенации строк и т.п.).  
- В handler/core удалить AST-специфичные костыли; в parser использовать компонент для таких случаев.

8) Компонент Block init  
- Создать `components/block_init.py` с API для imperative инициализаций (double-brace Java, Rust HashMap chain).  
- Удалить из старого `block_init.py` размещённые эвристики; подключить новый компонент из pipeline.

9) Компонент Placeholder/Comment  
- Создать `components/placeholder.py` для единого формирования плейсхолдеров/комментариев.  
- Удалить логику вставки комментариев из formatter и языковых обработчиков; оставить вызовы компонента.

10) Компонент Budgeting  
- Создать `components/budgeting.py` с политиками приоритетов/лимитов.  
- Убрать бюджетные решения из formatter/parser; pipeline передает бюджет в selector/компонент.

11) Полное отключение наследия core/handler  
- Удалить `core.py`/`handler.py`; обновить экспорты `lg/adapters/optimizations/literals/__init__.py` на `processing/` + `components/`.  
- Проверить, что адаптеры используют только pipeline/processing/компоненты.

12) Разгрузка языковых хаков  
- В языковых `literals.py` убрать специальные ветки, которые покрываются компонентами (interpolation, ast_sequence, block_init).  
- Оставить только декларативные профили/флаги в дескрипторах.

13) Финальная чистка структуры  
- Убрать временные типы/шунты, оставить минимально необходимый публичный API (patterns/descriptor/pipeline/компоненты).  
- Обновить `__init__.py` в `components/` и `processing/` для явных экспортов.
