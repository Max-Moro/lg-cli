# Руководство по тестированию языковых адаптеров

Это универсальное руководство по тестированию оптимизаций в языковых адаптерах Listing Generator. Оно применимо ко всем типам оптимизаций (literals, function_bodies, comments, imports, public_api, budget) и всем поддерживаемым языкам.

---

## Базовая инфраструктура

### Тестовый раннер

Основной инструмент: `./scripts/test_adapters.sh`

**Синтаксис**:
```bash
./scripts/test_adapters.sh <OPTIMIZATIONS> <LANGUAGES> [UPDATE_GOLDENS]
```

**Параметры**:
- `OPTIMIZATIONS` — тип оптимизации или `all` (список через запятую)
- `LANGUAGES` — язык или `all` (список через запятую)
- `UPDATE_GOLDENS` — `true` для обновления голденов (опционально, по умолчанию `false`)

**Примеры**:
```bash
# Все тесты для Python
./scripts/test_adapters.sh all python

# Комментарии для Python и TypeScript
./scripts/test_adapters.sh comments python,typescript

# Несколько оптимизаций для всех языков
./scripts/test_adapters.sh function_bodies,public_api all

# Обновить голдены для imports в Python
./scripts/test_adapters.sh imports python true

# Полный прогон
./scripts/test_adapters.sh all all
```

### Структура тестов

```
tests/adapters/
├── <язык>/
│   ├── test_<оптимизация>.py     # Тесты
│   ├── goldens/
│   │   ├── do/                    # Входные файлы
│   │   │   └── <оптимизация>.py
│   │   └── <оптимизация>/         # Эталонные результаты
│   │       └── <кейс>.py
│   └── utils.py                   # Утилиты для тестов
└── golden_utils.py                # Общие утилиты
```

### Особенности категории literals

Категория `literals` включает несколько подтипов тестов:
- `test_literals.py` — базовая оптимизация литералов
- `test_literal_comment_context.py` — позиционирование комментариев
- `test_literal_sets.py` — специфичные структуры (sets, tuples)
- `test_literals_indentation.py` — форматирование и отступы

При запуске `./scripts/test_adapters.sh literals <lang>` автоматически включаются все эти файлы.

---

## Принципы работы с голденами

### Философия golden-тестирования

**Золотое правило**: Любое изменение в голденах — это регрессия, пока не доказано обратное.

Голдены (golden files) — эталонные результаты оптимизаций. Они определяют корректное поведение адаптеров и защищают от непреднамеренных изменений.

### Политика изменения голденов

**Запрещено**:
- Коммитить изменённые голдены без явного понимания причины
- Обновлять голдены для "фикса" падающих тестов
- Использовать `UPDATE_GOLDENS=true` как способ "починить" тесты

**Разрешено**:
- Временно генерировать голдены для диагностики (`UPDATE_GOLDENS=true`)
- Изучать расхождения через `git diff` после временного обновления
- Откатывать изменённые голдены после анализа: `git restore tests/`

**Когда можно коммитить новые голдены**:
- Добавление нового теста (новый golden файл)
- Намеренное изменение формата вывода (с документированием в коммите)
- Исправление заведомо некорректного golden (с подробным объяснением)

---

## Стратегии тестирования

### 1. Точечные изменения (один файл)

**Когда**: Изменения в одном модуле языкового адаптера

**Пример**: Исправление бага в `python/literals.py`

**Стратегия**:
```bash
# Запуск тестов только для Python
./scripts/test_adapters.sh all python

# Если изменения только в literals
./scripts/test_adapters.sh literals python
```

**Ожидание**: Все тесты проходят без изменений в голденах

---

### 2. Изменения в общей инфраструктуре

**Когда**: Правки в `lg/adapters/optimizations/`, `lg/adapters/code_model.py`, базовых классах

**Пример**: Рефакторинг `LiteralPipeline`, изменения в `CommentOptimizer`

**Стратегия**:
```bash
# Всегда полный прогон для инфраструктурных изменений
./scripts/test_adapters.sh all all
```

**Ожидание**: Все 100+ тестов проходят, никаких изменений в голденах

---

### 3. Добавление новой оптимизации

**Когда**: Создание нового типа оптимизации или расширение существующей

**Пример**: Добавление поддержки новых паттернов в literals

**Стратегия**:
```bash
# Поэтапное добавление языков
./scripts/test_adapters.sh literals python      # Реализация для одного языка
./scripts/test_adapters.sh literals java,kotlin # Расширение на другие языки
./scripts/test_adapters.sh literals all         # Финальная проверка
```

**Ожидание**:
- Для нового функционала — новые тесты и новые голдены (коммитятся)
- Для расширения — старые тесты не меняются, новые тесты добавляются

---

### 4. Миграция на новую архитектуру

**Когда**: Масштабные рефакторинги с сохранением поведения

**Пример**: Переход на профили (literals v2), переписывание formatter

**Стратегия**:
```bash
# Миграция по одному языку
./scripts/test_adapters.sh all python
# После успеха для каждого языка

# Финальная проверка после всех языков
./scripts/test_adapters.sh all all
```

**Ожидание**: Нулевые изменения в голденах (backward compatibility)

---

### 5. Добавление нового языка

**Когда**: Реализация адаптера для нового языка

**Стратегия**:
```bash
# Создать структуру тестов
# tests/<новый_язык>/test_*.py
# tests/<новый_язык>/goldens/do/*.ext

# Запустить с генерацией голденов
./scripts/test_adapters.sh all <новый_язык> true

# Проверить качество сгенерированных голденов вручную

# Закоммитить новые голдены (это легитимно для нового языка)
git add tests/<новый_язык>/goldens/
git commit -m "Add <новый_язык> adapter with golden tests"
```

---

## Диагностика падений

### Быстрая локализация

**Шаг 1**: Определить scope проблемы

```bash
# Если падает один язык
./scripts/test_adapters.sh all python

# Если падают все языки с конкретной оптимизацией
./scripts/test_adapters.sh literals all

# Если нужна детальная информация по одному тесту
pytest tests/adapters/python/test_literals.py::TestClass::test_name -vv
```

**Шаг 2**: Анализ diff

```bash
# Временно обновить голдены для визуализации
./scripts/test_adapters.sh literals python true

# Посмотреть расхождения
git diff tests/adapters/python/goldens/

# ОБЯЗАТЕЛЬНО откатить после анализа
git restore tests/
```

---

### Стратегия при множественных падениях (>10)

1. **Группировка**: Сгруппировать падения по типу (языки, оптимизации, паттерны)
2. **Приоритизация**: Взять самый простой failing test
3. **Итеративность**: Решить один → перезапустить → часть может пройти автоматически
4. **Эскалация**: Если после 15-20 минут причина неясна → откат и пересмотр подхода

---

## Откат изменений

### Когда нужен откат

- Больше 5-10 падающих тестов после изменения
- Системная проблема, требующая переделки архитектуры
- Массовые изменения в голденах (>5 языков)
- Непонятная причина падений после 15-20 минут анализа

### Как откатить

```bash
# Полный откат всех изменений
git restore .

# Проверка baseline
./scripts/test_adapters.sh all all
# Должно быть: N passed (100+)

# Проверка что рабочее дерево чистое
git status
# Должно быть: working tree clean
```

### После отката

1. Проанализировать причину неудачи
2. Разбить изменение на более мелкие шаги
3. Начать с более атомарного изменения

---

## Чеклисты

### Перед началом работы

```bash
# 1. Убедиться что baseline чистый
git status
# Ожидание: working tree clean

# 2. Убедиться что все тесты проходят
./scripts/test_adapters.sh all all
# Ожидание: N passed (100+)
```

### После каждого изменения

```bash
# 1. Запустить тесты в appropriate scope
./scripts/test_adapters.sh <optimizations> <languages>

# 2. Проверить что голдены не изменились
git status
# Не должно быть: modified files in tests/adapters/*/goldens/

# 3. При успехе — коммит
git add <modified_files>
git commit -m "<meaningful message>"
```

### Перед финальным коммитом

```bash
# 1. Полная проверка
./scripts/test_adapters.sh all all
# Ожидание: 100+ passed

# 2. Проверка состояния
git status
# working tree clean кроме staged changes

# 3. Финальный коммит
git commit -m "<summary of changes>"
```

---

## Временные техники диагностики

### Разрешённые техники

**Debug logging в продуктовом коде**:
```python
# Временно добавить для диагностики
import logging
logging.debug(f"Processing literal: {text[:50]}")
```
⚠️ Удалить после фикса!

**Временные тесты**:
```python
def test_debug_specific_case():
    # Временный тест без golden для детального анализа
    result = adapter.process(...)
    print(result)  # Можно использовать print для debug
    assert "expected" in result
```

**Подсмотр старой реализации**:
```bash
# Посмотреть как было раньше
git log -p -- lg/adapters/optimizations/literals/
```
⚠️ Решение должно соответствовать новой архитектуре!

### Запрещённые техники

❌ Править голдены вручную для "фикса" тестов

❌ Коммитить debug logging в production код

❌ Копировать старую реализацию без адаптации к новой архитектуре

---

## Оптимизация времени прогона

### Быстрые проверки

```bash
# Только изменённый язык
./scripts/test_adapters.sh all python         # ~5-10 сек

# Только конкретная оптимизация
./scripts/test_adapters.sh literals python    # ~2-5 сек

# Один тест для быстрой итерации
pytest tests/adapters/python/test_literals.py::TestClass::test_name  # ~1 сек
```

### Когда нужен полный прогон

- Изменения в базовых классах (BaseAdapter, CodeAdapter)
- Изменения в общей инфраструктуре (optimizations/*)
- Перед финальным коммитом крупного этапа
- После отката для проверки baseline

---

## Заключение

**Основные принципы**:

1. **Голдены — истина**: Любое изменение требует понимания причины
2. **Атомарность**: Маленькие изменения легче отлаживать
3. **Откат — не провал**: Быстрый откат лучше долгой борьбы с проблемой
4. **Scope-aware тестирование**: Не гонять все тесты для точечных изменений
5. **Baseline чистота**: Всегда начинать с проходящих тестов

При следовании этим принципам тестирование становится эффективным инструментом разработки, а не бременем.
