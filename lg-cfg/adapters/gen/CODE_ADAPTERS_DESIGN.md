# Дизайн языковых адаптеров Listing Generator

## Обзор

Система языковых адаптеров предназначена для интеллектуальной оптимизации листингов исходного кода при составлении контекстов для AI-агентов. Цель — предоставить агентам необходимую информацию о структуре кода и зависимостях, минимизируя при этом количество "мусорных" токенов.

## Архитектура

### Базовые компоненты

1. **`CodeCfg`** — базовая модель конфигурации для всех языковых адаптеров
2. **`CodeAdapter`** — базовый класс с общей функциональностью обработки кода
3. **`CodeDocument`** — промежуточное представление для разобранного кода
4. **Язык-специфичные адаптеры** — реализации для конкретных языков программирования

### Поддерживаемые языки

- **Python** (`.py`) — с расширенной поддержкой по сравнению с текущей версией
- **TypeScript** (`.ts`, `.tsx`) — экспортный API, JSX, типы
- **JavaScript** (`.js`, `.jsx`) — аналогично TS, но без типов
- **Java** (`.java`) — публичные API, аннотации, Lombok
- **C/C++** (`.c`, `.cpp`, `.h`, `.hpp`) — заголовки vs реализации, макросы
- **Scala** (`.scala`) — given/using, case classes, companion objects

## Основные возможности оптимизации

### 1. Удаление тел функций (`strip_function_bodies`)

Возможные режимы:
- `none` — не удалять тела
- `all` — удалять все тела функций/методов
- `public_only` — удалять только у публичных функций
- `non_public` — удалять только у приватных функций
- `large_only` — удалять только у функций свыше N строк

Дополнительные опции:
- `min_lines` — минимальное количество строк для удаления
- `except_patterns` — regex исключений по именам функций
- `keep_annotated` — regex аннотаций, при которых тело сохраняется

### 2. Обработка комментариев (`comment_policy`)

Режимы:
- `keep_all` — сохранять все комментарии
- `strip_all` — удалять все комментарии
- `keep_doc` — сохранять только docstring'и/документацию
- `keep_first_sentence` — сохранять только первое предложение из документации

Дополнительные опции:
- `max_length` — максимальная длина сохраняемого комментария
- `keep_annotations` — regex аннотаций для сохранения (TODO, FIXME, etc.)
- `strip_patterns` — regex паттернов для принудительного удаления

### 3. Фильтрация по публичности (`public_api_only`)

При включении сохраняются только:
- Публичные классы, функции, методы
- Экспортируемые элементы (TS/JS)
- Элементы с публичными модификаторами доступа
- Интерфейсы и типы

### 4. Обработка импортов (`import_config`)

Политики:
- `keep_all` — сохранять все импорты
- `external_only` — только внешние пакеты/библиотеки
- `summarize_long` — сворачивать длинные списки импортов

Опции:
- `max_items_before_summary` — количество импортов для включения суммаризации
- `external_only_patterns` — regex для определения внешних пакетов

### 5. Усечение литералов (`literal_config`)

Ограничения на размеры данных:
- `max_string_length` — максимальная длина строковых литералов
- `max_array_elements` — максимальное количество элементов массива
- `max_object_properties` — максимальное количество свойств объекта
- `max_literal_lines` — максимальное количество строк для литерала
- `collapse_threshold` — размер в байтах для включения сворачивания

### 6. Обработка полей (`field_config`)

Опции:
- `keep_initializers` — сохранять инициализаторы полей
- `max_initializer_length` — максимальная длина инициализатора
- `strip_trivial_accessors` — удалять тривиальные геттеры/сеттеры (Java)

### 7. Бюджетирование токенов (`budget`)

Ограничение общего размера:
- `max_tokens_per_file` — максимальное количество токенов на файл
- `priority_order` — порядок приоритета при превышении бюджета:
  - `imports` — импорты (высокий приоритет)
  - `types` — объявления типов
  - `public_methods` — публичные методы
  - `fields` — поля
  - `private_methods` — приватные методы
  - `docs` — документация (низкий приоритет)

## Система плейсхолдеров

### Унифицированная модель

Все языки используют единую систему плейсхолдеров с адаптацией под синтаксис комментариев:

- **Python**: `# … {kind} {name} (−{lines})`
- **JS/TS/Java/C++/Scala**: `/* … {kind} {name} (−{lines}) */`

### Типы плейсхолдеров

1. **Основной шаблон** (`template`) — для удаленных функций, классов, etc.
2. **Тела функций** (`body_template`) — для удаленных тел при сохранении сигнатур
3. **Импорты** (`import_template`) — для свернутых списков импортов
4. **Литералы** (`literal_template`) — для усеченных данных

### Переменные шаблонов

- `{kind}` — тип элемента (function, method, class, import, literal)
- `{name}` — имя элемента
- `{lines}` — количество удаленных строк
- `{bytes}` — количество удаленных байт
- `{count}` — количество элементов (для групповых операций)

### Стили размещения

- `auto` — автоматический выбор (inline для малых, block для больших)
- `inline` — в той же строке что и код
- `block` — отдельной строкой
- `none` — без плейсхолдеров

## Язык-специфичные расширения

### Python

- Сохранение логики для `__init__.py` из существующего адаптера
- Понимание декораторов (`@property`, `@classmethod`, etc.)
- Обработка docstring'ов в тройных кавычках

### TypeScript/JavaScript

- `exported_only` — по умолчанию true для TS
- Понимание JSX синтаксиса
- Обработка type-only импортов
- Barrel files (`index.ts`) — специальная обработка реэкспортов

### Java

- `strip_trivial_accessors` — автоматическое удаление геттеров/сеттеров
- Понимание аннотаций Spring, JPA, Lombok
- Обработка generic типов

### C/C++

- `header_mode` — режим для заголовочных файлов (declarations_only)
- `macro_policy` — обработка препроцессорных макросов
- Различение `.h/.hpp` и `.c/.cpp` файлов

### Scala

- `keep_given_using` — сохранение given/using/implicit сигнатур
- `case_class_policy` — политика для case классов
- Обработка companion objects

## Адресная конфигурация через `targets`

Система позволяет применять разные стратегии оптимизации к разным участкам кодовой базы:

```yaml
targets:
  # API модули - только публичные интерфейсы
  - match: ["**/api/**", "**/interfaces/**"]
    python:
      public_api_only: true
      strip_function_bodies: true
    
  # Тесты - минимальный объем
  - match: ["**/test/**"]
    python:
      strip_function_bodies: true
      comment_policy: "strip_all"
    
  # Утилиты - бюджетирование
  - match: ["**/utils/**"]
    python:
      budget:
        max_tokens_per_file: 500
```

## Метрики и отчетность

Каждый адаптер предоставляет детальные метрики в поле `meta`:

```json
{
  "code.removed.functions": 15,
  "code.removed.methods": 8,
  "code.removed.comments": 42,
  "code.removed.imports": 3,
  "code.removed.literals": 2,
  "code.trimmed.fields": 5,
  "code.placeholders": 18,
  "code.lines_saved": 245,
  "code.bytes_saved": 8960,
  "_adapter": "python",
  "_group_size": 1,
  "_group_mixed": false
}
```

## Расширяемость

Система спроектирована для легкого добавления новых языков:

1. Создать класс, наследующий от `CodeAdapter[YourLangCfg]`
2. При необходимости переопределить методы оптимизации
3. Зарегистрировать через `register_lazy()` в `__init__.py`

## Интеграция с существующей системой

Новые адаптеры полностью совместимы с существующей архитектурой:
- Используют ту же систему кэширования
- Поддерживают адресные оверрайды через `targets`
- Интегрируются с системой плейсхолдеров
- Предоставляют метрики для статистики токенов

## Будущие возможности

- **AI-guided optimization** — использование ML для автоматического выбора оптимальных настроек
- **Cross-language awareness** — понимание зависимостей между файлами разных языков
- **Incremental parsing** — инкрементальная обработка при изменениях кода
- **Custom transformations** — пользовательские правила трансформации кода
