# GitHub Actions Workflow: Release
#
# Manual workflow to publish a new release:
# 1. Build wheel and sdist distributions
# 2. Extract version changelog section from CHANGELOG.md
# 3. Publish package to PyPI
# 4. Create GitHub Release with changelog notes
#
# Prerequisites: CHANGELOG.md must contain [X.Y.Z] section matching pyproject.toml version
#
# Trigger: Manual (workflow_dispatch)

name: Release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Pre-release (mark as pre-release on GitHub)'
        required: false
        type: boolean
        default: false

jobs:
  # Job 1: Build distributions
  build:
    name: Build Package
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.properties.outputs.version }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - name: Fetch Sources
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'pyproject.toml'

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Extract Version
        id: properties
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Validate Version vs Branch
        run: |
          VERSION="${{ steps.properties.outputs.version }}"
          BRANCH="${{ github.ref_name }}"

          echo "Validating version $VERSION against branch $BRANCH"

          # Extract MAJOR.MINOR from version (e.g., "0.9.0" -> "0.9")
          VERSION_PREFIX=$(echo "$VERSION" | cut -d. -f1,2)

          # Check if branch is maintenance/next branch
          # Matches: v0.9.x, next-v0.9.x, 0.9.x, next-0.9.x
          if [[ "$BRANCH" =~ ^(next-)?v?([0-9]+\.[0-9]+)\.x$ ]]; then
            BRANCH_VERSION="${BASH_REMATCH[2]}"

            if [ "$VERSION_PREFIX" != "$BRANCH_VERSION" ]; then
              echo "❌ ERROR: Version mismatch!"
              echo ""
              echo "  Version in pyproject.toml: $VERSION (${VERSION_PREFIX}.x series)"
              echo "  Current branch: $BRANCH (${BRANCH_VERSION}.x series)"
              echo ""
              echo "Cannot release version $VERSION from branch $BRANCH"
              echo ""
              echo "Possible solutions:"
              echo "  1. Update version in pyproject.toml to ${BRANCH_VERSION}.Z"
              echo "  2. Switch to correct branch for version $VERSION"
              exit 1
            fi

            echo "✅ Version $VERSION matches branch $BRANCH (${BRANCH_VERSION}.x series)"
          else
            echo "✅ No version constraint for branch $BRANCH (any version allowed)"
          fi

      - name: Extract Changelog
        id: changelog
        run: |
          VERSION="${{ steps.properties.outputs.version }}"
          python - "$VERSION" <<EOF
          import re
          import os
          import sys

          version = sys.argv[1]

          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              content = f.read()

          # Extract [X.Y.Z] section for the current version
          # Escape dots in version for regex
          version_escaped = re.escape(version)
          pattern = rf'## \[{version_escaped}\][^\n]*\n(.*?)(?=\n## \[|$)'
          match = re.search(pattern, content, re.DOTALL)

          if not match:
              print(f"ERROR: [{version}] section not found in CHANGELOG.md")
              print(f"Please ensure CHANGELOG.md contains a section for version {version}")
              exit(1)

          changelog_content = match.group(1).strip()

          if not changelog_content:
              print(f"ERROR: [{version}] section is empty")
              exit(1)

          # Write to output (handle multiline)
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"content<<EOF\n{changelog_content}\nEOF\n")

          print(f"Extracted changelog for v{version}:")
          print(changelog_content)
          EOF

      - name: Build Distributions
        run: python -m build

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: distributions
          path: dist/*

  # Job 2: Publish to PyPI and create GitHub Release
  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for Trusted Publishing
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v7
        with:
          name: distributions
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # Automatically uses Trusted Publishing (OIDC) via id-token permission
        # No password needed - PyPI verifies via GitHub OIDC token

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: v${{ needs.build.outputs.version }}
          body: |
            ## Changelog

            ${{ needs.build.outputs.changelog }}

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md
          files: dist/*
          prerelease: ${{ github.event.inputs.prerelease }}
          draft: false

