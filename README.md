# Listing Generator (lg)

Генератор plain‑text‑листинга исходников для AI‑ассистентов, code‑review и быстрого обмена контекстом.

---

## Зачем нужен этот инструмент?

Современные AI‑копилоты (ChatGPT, Copilot Chat, Gemini, Claude и др.) работают лучше всего, когда видят **весь релевантный код одним куском**. Копировать десятки файлов вручную — боль, а отдавать весь репозиторий архивом — расточительно по токенам.
`lg` обходит дерево проекта, сшивает подходящие файлы в единый компактный листинг и печатает его в `stdout` — готово к вставке или пайпу куда угодно.

Используйте, чтобы:

* показать только изменённые файлы перед коммитом;
* поделиться минимальным воспроизводимым примером с коллегами или в баг‑репорте;
* сделать снапшот кода для рефакторинга или генерации документации с помощью LLM.

---

## Ключевые возможности

| Возможность                           | Детали                                                                                          |
| ------------------------------------- |-------------------------------------------------------------------------------------------------|
| **Кроссплатформенная CLI**            | Windows, macOS, Linux. Внешние бинарники не нужны.                                              |
| **Автопоиск корня проекта**           | Поднимается вверх в поисках `.git` или `listing_config.yaml`.                                   |
| **Понимание `.gitignore`**            | Использует ваши правила игнора (полный синтаксис при установленном пакете `pathspec`).          |
| **YAML-конфиг**                       | Human-friendly, поддерживает комментарии, вложенность и типизацию через dataclass-модели.       |
| **Продвинутая фильтрация**            | Белые / черные (`allow`/`block`) списки с рекурсивными правилами на каждом уровне дерева.       |
| **Несколько расширений**              | Настраиваемый список: `.py`, `.md`, `.qml` и др.                                                |
| **Режимы `all` и `changes`**          | Листинг всех файлов **или** только изменённых в рабочем дереве (staged + unstaged + untracked). |
| **Диагностика фильтров**              | Флаг `--list-included` выводит только пути, прошедшие фильтрацию (debug-режим).                 |
| **Плагинные адаптеры**                | Языко-специфичные правила лежат в `lg/adapters/`. Можно добавить новые без правок ядра.         |
| **Дружит с сабмодулями**              | Инструмент живёт в отдельном репо — подключайте через `git submodule` или симлинк.              |
| **Python 3.8+**                       | Тестировалось до 3.12. Нулевые runtime-зависимости (dev-зависимости только для разработки).     |

---

## Структура репозитория

```
lg/               ← это репозиторий инструмента (может быть субмодулем)
├─ lg/
│   ├─ adapters/
│   │   ├─ python_.py
│   │   └─ …
│   ├─ config/
│   │    └─ model.py
│   ├─ core/
│   │   └─ generator.py
│   ├─ filters/
│   │    ├─ engine.py
│   │    └─ model.py
│   ├─ cli.py     ← точка входа (`listing-generator`)
│   └─ utils.py
├─ tests/
├─ pyproject.toml
└─ README.md
```

В *проекте‑клиенте* обычно так:

```
my-project/
├─ lg/                     # субмодуль или симлинк
├─ listing_config.yaml     # правила конкретно этого проекта
└─ …
```

---

## Подключение инструмента к проекту

### Git‑сабмодуль (рекомендуемый способ)

```bash
# Добавить сабмодуль в каталог lg/
git submodule add https://github.com/your-org/lg.git lg

# Инициализировать/обновить после клонирования
git submodule update --init --remote

# Получить свежую версию инструмента позднее
git submodule update --remote lg
```

> **Плюсы**: версия инструмента фиксируется хэшем, подходит для любых ОС, легко обновлять через Git.  
> **Минусы**: команда `git clone` нужна с флагом `--recursive` *или* отдельной инициализацией субмодулей.

---

### Символическая ссылка (для локальной разработки)

> Работает только если вся команда использует совместимую ОС; симлинки в Windows требуют режим *Developer Mode* или админ‑права.

**Windows (PowerShell ≥ 5):**

```powershell
New-Item -ItemType SymbolicLink -Path lg -Target C:\path\to\lg
```

**Linux / macOS:**

```bash
ln -s ~/dev/lg lg
```

После создания симлинка инструмент доступен так же, как и при использовании сабмодуля.

---

### Способы запуска после подключения

| Вариант                            | Команда из корня проекта                                                                                                                               | Комментарии                                                                                                                               |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------- |
| **Editable‑режим** | `pip install -e ./lg`  ← один раз<br>`listing-generator --config my.listing_config.json`                                                               | Самый короткий UX. Пакет `lg` добавляется в `PYTHONPATH`, появляется entry‑point `listing-generator`. Конфликтов с dev‑зависимостями нет. |
| **Двойной namespace**              | `python -m lg.lg.cli --root . --config my.listing_config.json`                                                                                         | Работает без установки. Полезно, если нельзя писать в venv или хочется «разового» запуска.                                                |
| **Run‑конфигурация PyCharm**       | *Type*: **Python**.<br>*Script*: `<MODULE>`.<br>*Module name*: `lg.cli`.<br>*Parameters*: `--root . --config my.listing_config.json --mode changes` | Позволяет запускать генератор одной кнопкой ⏵ в IDE. Работает с сабмодулем и симлинком.                                                   |

По умолчанию:

* ищется `listing_config.yaml` в текущей директории;
* режим `all`: берутся все подходящие файлы;
* применяются `.gitignore` + YAML-фильтрация;
* выводится единый текстовый листинг.

## CLI-опции

```text
usage: listing-generator [-h] [-c CONFIG] [--mode {all,changes}]
                         [--list-included] [--root ROOT] [-v]

options:
  -h, --help            Show this help message and exit.
  -c, --config PATH     Путь к YAML-конфигу (default: listing_config.yaml)
  --mode {all,changes}  all = весь проект; changes = только изменённые
  --list-included       Вывести только пути, прошедшие фильтрацию (debug)
  --root ROOT           Корень проекта для обхода (default: .)
  -v, --verbose         Увеличить подробность логов; можно -vv
```

---

## Конфигурация (`listing_config.yaml`)

```yaml
# listing_config.yaml
schema_version: 3

# --- Глобальные настройки ---
# Пропускать пустые файлы по умолчанию
skip_empty: true

# Какие расширения обрабатывать
extensions:
  - ".py"
  - ".java"

# --- Параметры адаптеров ---
python:
  # Пропускать полностью пустые .py-файлы
  skip_empty: true
  # Пропускать тривиальные __init__.py
  skip_trivial_inits: true
  # Максимум значимых строк в __init__.py для его оставления
  trivial_init_max_noncomment: 1

java:
  # Не пропускать пустые .java-файлы
  skip_empty: false
  # Пропускать файлы с только Spring-аннотациями
  skip_trivial_spring_annots: true

# --- Система фильтрации (Allow/Block-Tree) ---
filters:
  # ------------------------------------------------------------------
  # 1) ГЛОБАЛЬНЫЙ УЗЕЛ (КОРЕНЬ РЕПО)
  #    strategy: “разрешено всё, КРОМЕ явно перечисленного”
  # ------------------------------------------------------------------
  mode: block                 # default-allow
  block:                      # → вычёркиваем мусор, бинарники и большие данные
    - ".git/"
    - "**/__pycache__/**"
    - "**/*.pyc"
    - "**/*.log"
    - "node_modules/"

  # ------------------------------------------------------------------
  # 2) ПОДДЕРЕВО secure/ — переворачиваем логику:
  #    strategy: “запрещено всё, КРОМЕ явно перечисленного”
  # ------------------------------------------------------------------
  children:
    secure:
      mode: allow             # default-deny
      allow:                  # → раскрываем ровно то, что нужно ревью
        - "*.py"              # код
        - "*.md"              # документация

      # --------------------------------------------------------------
      # 3) точечный сабдиректории secure/artifacts/
      #    здесь снова «доступно всё, кроме *.tmp»
      # --------------------------------------------------------------
      children:
        artifacts:
          mode: block         # default-allow
          block:
            - "**/*.tmp"
```

Фильтрация делается **до** языковых адаптеров:

1. Сначала применяется `.gitignore`-правило (через `pathspec`).
2. Затем — дерево `filters` из `listing_config.yaml`.
   * `mode: allow`  → белый список (по умолчанию всё запрещено).
   * `mode: block`  → чёрный список (по умолчанию всё разрешено).
   * При пересечении allow+block — блокировка сильнее.
   * Директория `foo/` эквивалентна маске `foo/**`.
   * Все пути обрабатываются как POSIX-lowercase.
3. Только допущенные файлы доходят до адаптера, где ещё отбрасываются пустые или тривиальные.

---

## Разработка

```bash
# установка инструментов разработчика
pip install -e .[dev]

# запуск юнит-тестов
pytest -q
```

---

## Лицензия

MIT License — подробности в файле `LICENSE`.
