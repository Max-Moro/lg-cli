# Listing Generator (lg)

Генератор plain‑text‑листинга исходников для AI‑ассистентов, code‑review и быстрого обмена контекстом.

---

## Зачем нужен этот инструмент?

Современные AI‑копилоты (ChatGPT, Copilot Chat, Gemini, Claude и др.) работают лучше всего, когда видят **весь релевантный код одним куском**. Копировать десятки файлов вручную — боль, а отдавать весь репозиторий архивом — расточительно по токенам.
`lg` обходит дерево проекта, **сшивает подходящие файлы в единый компактный листинг** и печатает его в `stdout` — готово к вставке или пайпу куда угодно.

Используйте, чтобы:

* показать только изменённые файлы перед коммитом;
* поделиться минимальным воспроизводимым примером с коллегами или в баг‑репорте;
* сделать снапшот кода для рефакторинга или генерации документации с помощью LLM.

---

## Ключевые возможности

| Возможность                           | Детали                                                                                          |
| ------------------------------------- | ----------------------------------------------------------------------------------------------- |
| **Кроссплатформенная CLI**            | Windows, macOS, Linux. Внешние бинарники не нужны.                                              |
| **Автопоиск корня проекта**           | Поднимается вверх в поисках `.git` или `listing_config.json`.                                   |
| **Понимание `.gitignore`**            | Использует ваши правила игнора (полный синтаксис при установленном пакете `pathspec`).          |
| **Несколько расширений**              | Настраиваемый список: `.py`, `.md`, `.qml`, …                                                   |
| **Режимы `all` и `changes`**          | Листинг всех файлов **или** только изменённых в рабочем дереве (staged + unstaged + untracked). |
| **Пропуск пустых/тривиальных файлов** | Опциональные эвристики для игнора пустых файлов и шаблонных `__init__.py`.                      |
| **Самоисключение**                    | Автоматически игнорирует собственный каталог (`lg/`) и конфиг.                                  |
| **Плагинные адаптеры**                | Языко‑специфичные правила лежат в `lg/adapters/`. Можно добавить новый язык без правок ядра.    |
| **Дружит с сабмодулями**              | Инструмент живёт в отдельном репо — подключайте через `git submodule` или симлинк.              |
| **Python 3.8+**                       | Тестировалось до 3.12. Нулевые runtime‑зависимости (dev‑зависимости только для разработки).     |

---

## Структура репозитория

```
lg/               <— это репозиторий инструмента (может быть субмодулем)
│   pyproject.toml
│   README.md
│   lg/
│   ├─ __init__.py
│   ├─ cli.py       ← точка входа (`listing-generator`)
│   ├─ config.py
│   ├─ utils.py
│   ├─ filters.py
│   ├─ core/
│   │   └─ generator.py
│   └─ adapters/
│       ├─ python_.py
│       └─ …
└─ tests/
```

В *проекте‑клиенте* обычно так:

```
my-project/
├─ lg/                     # субмодуль или симлинк
├─ listing_config.json     # правила конкретно этого проекта
└─ …
```

---

## Подключение инструмента к проекту

### Git‑сабмодуль (рекомендуемый способ)

```bash
# Добавить сабмодуль в каталог lg/
git submodule add https://github.com/your-org/lg.git lg

# Инициализировать/обновить после клонирования
git submodule update --init --remote

# Получить свежую версию инструмента позднее
git submodule update --remote lg
```

> **Плюсы**: версия инструмента фиксируется хэшем, подходит для любых ОС, легко обновлять через Git.
> **Минусы**: команда `git clone` нужна с флагом `--recursive` *или* отдельной инициализацией субмодулей.

---

### Символическая ссылка (для локальной разработки)

> Работает только если вся команда использует совместимую ОС; симлинки в Windows требуют режим *Developer Mode* или админ‑права.

**Windows (PowerShell ≥ 5):**

```powershell
New-Item -ItemType SymbolicLink -Path lg -Target C:\path\to\lg
```

**Linux / macOS:**

```bash
ln -s ~/dev/lg lg
```

После создания симлинка инструмент доступен так же, как и при использовании сабмодуля.

---

## Быстрый старт (Windows + PowerShell)

```ps1
# 1 · клонируем инструмент (как субмодуль или отдельно)
cd my-project
git submodule add https://github.com/your-org/lg.git lg

# 2 · создаём и активируем venv
py -3.12 -m venv .venv
.venv\Scripts\Activate.ps1

# 3 · ставим пакет в editable-режиме + dev-зависимости
python -m pip install -e .\lg[dev]

# 4 · генерируем полный листинг
listing-generator > listing.txt

# или только изменённые файлы
listing-generator --mode changes > patch.txt
```

### То же под Linux/macOS

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -e ./lg[dev]
listing-generator --mode changes | less
```

---

## Конфигурация (`listing_config.json`)

```jsonc
{
  "schema_version": 1,
  "extensions": [".py"],
  "exclude": [
    ".idea/",
    "__pycache__/",
    "**/__pycache__/**"
  ],
  "skip_empty": true,
  "skip_trivial_inits": true,
  "trivial_init_max_noncomment": 1
}
```

> Любой ключ можно опустить — будет использовано значение по умолчанию.

---

## Разработка

```bash
# установка инструментов разработчика
pip install -e .[dev]

# запуск юнит-тестов
pytest -q
```

### Чек‑лист тестирования

* Новые фичи сопровождаются юнит‑тестами в `tests/`.
* `pytest -q` должен проходить на Windows, macOS и Linux.
* CI (GitHub Actions) всегда зелёный.

---

## Вклад в проект

1. Fork → feature‑branch → PR.
2. Соблюдайте стиль кода (`ruff format`).
3. Обновляйте `CHANGELOG.md` в разделе *Unreleased*.
4. Добавляйте тесты и документацию по мере необходимости.

Мы рады новым языковым адаптерам, багфиксам и улучшениям UX!

---

## Дорожная карта

* **Футер со статистикой** (файлы/строки/байты).
* **Markdown‑режим** с блоками \`\`\` вместо `# —— FILE ——`.
* **ZIP‑снапшот** по флагу CLI.
* **Обнаружение адаптеров** через `importlib.metadata.entry_points()`.
* **Self‑update** для пользователей субмодулей.

---

## Лицензия

MIT License — подробности в `LICENSE`.
