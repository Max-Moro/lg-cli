# Listing Generator (lg)

Генератор plain‑text‑листинга исходников для AI‑ассистентов, code‑review и быстрого обмена контекстом.

---

## Зачем нужен этот инструмент?

Современные AI‑копилоты (ChatGPT, Copilot Chat, Gemini, Claude и др.) работают лучше всего, когда видят **весь релевантный код одним куском**. Копировать десятки файлов вручную — боль, а отдавать весь репозиторий архивом — расточительно по токенам.
`lg` обходит дерево проекта, **сшивает подходящие файлы в единый компактный листинг** и печатает его в `stdout` — готово к вставке или пайпу куда угодно.

Используйте, чтобы:

* показать только изменённые файлы перед коммитом;
* поделиться минимальным воспроизводимым примером с коллегами или в баг‑репорте;
* сделать снапшот кода для рефакторинга или генерации документации с помощью LLM.

---

## Ключевые возможности

| Возможность                           | Детали                                                                                          |
| ------------------------------------- | ----------------------------------------------------------------------------------------------- |
| **Кроссплатформенная CLI**            | Windows, macOS, Linux. Внешние бинарники не нужны.                                              |
| **Автопоиск корня проекта**           | Поднимается вверх в поисках `.git` или `listing_config.json`.                                   |
| **Понимание `.gitignore`**            | Использует ваши правила игнора (полный синтаксис при установленном пакете `pathspec`).          |
| **Несколько расширений**              | Настраиваемый список: `.py`, `.md`, `.qml`, …                                                   |
| **Режимы `all` и `changes`**          | Листинг всех файлов **или** только изменённых в рабочем дереве (staged + unstaged + untracked). |
| **Пропуск пустых/тривиальных файлов** | Опциональные эвристики для игнора пустых файлов и шаблонных `__init__.py`.                      |
| **Самоисключение**                    | Автоматически игнорирует собственный каталог (`lg/`) и конфиг.                                  |
| **Плагинные адаптеры**                | Языко‑специфичные правила лежат в `lg/adapters/`. Можно добавить новый язык без правок ядра.    |
| **Дружит с сабмодулями**              | Инструмент живёт в отдельном репо — подключайте через `git submodule` или симлинк.              |
| **Python 3.8+**                       | Тестировалось до 3.12. Нулевые runtime‑зависимости (dev‑зависимости только для разработки).     |

---

## Структура репозитория

```
lg/               <— это репозиторий инструмента (может быть субмодулем)
│   pyproject.toml
│   README.md
│   lg/
│   ├─ __init__.py
│   ├─ cli.py       ← точка входа (`listing-generator`)
│   ├─ config.py
│   ├─ utils.py
│   ├─ core/
│   │   └─ generator.py
│   └─ adapters/
│       ├─ python_.py
│       └─ …
└─ tests/
```

В *проекте‑клиенте* обычно так:

```
my-project/
├─ lg/                     # субмодуль или симлинк
├─ listing_config.json     # правила конкретно этого проекта
└─ …
```

---

## Подключение инструмента к проекту

### Git‑сабмодуль (рекомендуемый способ)

```bash
# Добавить сабмодуль в каталог lg/
git submodule add https://github.com/your-org/lg.git lg

# Инициализировать/обновить после клонирования
git submodule update --init --remote

# Получить свежую версию инструмента позднее
git submodule update --remote lg
```

> **Плюсы**: версия инструмента фиксируется хэшем, подходит для любых ОС, легко обновлять через Git.
> **Минусы**: команда `git clone` нужна с флагом `--recursive` *или* отдельной инициализацией субмодулей.

---

### Символическая ссылка (для локальной разработки)

> Работает только если вся команда использует совместимую ОС; симлинки в Windows требуют режим *Developer Mode* или админ‑права.

**Windows (PowerShell ≥ 5):**

```powershell
New-Item -ItemType SymbolicLink -Path lg -Target C:\path\to\lg
```

**Linux / macOS:**

```bash
ln -s ~/dev/lg lg
```

После создания симлинка инструмент доступен так же, как и при использовании сабмодуля.

---

### Способы запуска после подключения

| Вариант                            | Команда из корня проекта                                                                                                                               | Комментарии                                                                                                                               |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------- |
| **Editable‑режим** | `pip install -e ./lg`  ← один раз<br>`listing-generator --config my.listing_config.json`                                                               | Самый короткий UX. Пакет `lg` добавляется в `PYTHONPATH`, появляется entry‑point `listing-generator`. Конфликтов с dev‑зависимостями нет. |
| **Двойной namespace**              | `python -m lg.lg.cli --root . --config my.listing_config.json`                                                                                         | Работает без установки. Полезно, если нельзя писать в venv или хочется «разового» запуска.                                                |
| **Run‑конфигурация PyCharm**       | *Type*: **Python**.<br>*Script*: `<MODULE>`.<br>*Module name*: `lg.cli`.<br>*Parameters*: `--root . --config my.listing_config.json --mode changes` | Позволяет запускать генератор одной кнопкой ⏵ в IDE. Работает с сабмодулем и симлинком.                                                   |

#### Доступные аргументы CLI

| Аргумент                | Значение по умолчанию    | Описание                                                                                               |
| ----------------------- | ------------------------ | ------------------------------------------------------------------------------------------------------ |
| `-c, --config PATH`     | `listing_config.json`    | Путь к конфигурационному JSON.                                                                         |
| `--mode {all, changes}` | `all`                    | `all` — листинг всех подходящих файлов. `changes` — только изменённые (staged + unstaged + untracked). |
| `--root PATH`           | `.` (текущая директория) | Явно задать корень проекта, если запускаетесь из подкаталога.                                          |
| `-v, --verbose`         | *(0)*                    | Увеличить подробность логов (`-v`, `-vv`).                                                             |

---

## Конфигурация (`listing_config.json`)

```jsonc
{
  "schema_version": 1,

  // Глобальные правила (работают только если язык не распознан)
  "skip_empty": true,

  // Пусть проект содержит Python и Java
  "extensions": [".py", ".java"],

  "python": {
    "skip_empty": true,
    "skip_trivial_inits": true,
    "trivial_init_max_noncomment": 1
  },

  "java": {
    "skip_empty": false,
    "skip_trivial_spring_annots": true
  }
}
```

> Любой ключ можно опустить — будет использовано значение по умолчанию.

---

## Разработка

```bash
# установка инструментов разработчика
pip install -e .[dev]

# запуск юнит-тестов
pytest -q
```

---

## Лицензия

MIT License — подробности в `LICENSE`.
